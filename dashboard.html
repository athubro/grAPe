<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Grape Classroom</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="grape.png" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #5b21b6; font-family: 'Inter', sans-serif; color: #ffffff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 1.5rem; }
    nav { display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 1200px; padding: 0.75rem 1rem; background: #5b21b6; border-bottom: 1px solid #c4b5fd; }
    #courses { font-size: 1.25rem; font-weight: 700; color: #c4b5fd; transition: color 0.3s ease, transform 0.3s ease; }
    #courses:hover { color: #a78bfa; transform: scale(1.05); }
    #xp-display { display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 600; color: #8b5cf6; }
    #xp-display::before { content: 'Trophy'; font-size: 1.25rem; color: #c4b5fd; transition: transform 0.3s ease; }
    #xp-display:hover::before { transform: rotate(15deg); }
    #settingsBtn { width: 1.5rem; height: 1.5rem; filter: invert(29%) sepia(69%) saturate(1485%) hue-rotate(235deg) brightness(90%) contrast(89%); transition: transform 0.3s ease, filter 0.3s ease; cursor: pointer; }
    #settingsBtn:hover { filter: invert(62%) sepia(67%) saturate(1350%) hue-rotate(231deg) brightness(99%) contrast(94%); transform: rotate(90deg); }
    #course-select { width: 100%; background: #5b21b6; border: 1px solid #a78bfa; border-radius: 0.75rem; padding: 0.75rem; font-size: 1rem; color: #ffffff; box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2); transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; appearance: none; background-image: url("data:image/svg+xml;utf8,<svg fill='%23a78bfa' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5rem; }
    #course-select:hover { transform: translateY(-2px); box-shadow: 0 6px 12px -2px rgba(139, 92, 246, 0.3); border-color: #8b5cf6; }
    #course-select:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px #c4b5fd; }
    #units-list button { display: block; width: 100%; background: #5b21b6; border: 1px solid #a78bfa; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; text-align: left; color: #ffffff; transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease; }
    #units-list button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px -2px rgba(139, 92, 246, 0.3); background: #6d28d9; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 50; }
    .modal.show { display: flex !important; }
    .modal .card { background: linear-gradient(135deg, #6d28d9, #5b21b6); border: 1px solid #a78bfa; box-shadow: 0 10px 20px rgba(139, 92, 246, 0.15); border-radius: 1rem; padding: 1.5rem; width: 100%; max-width: 500px; color: #ffffff; position: relative; overflow: hidden; }
    .modal .card::before { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.05); backdrop-filter: blur(8px); pointer-events: none; }
    .modal .card > * { position: relative; z-index: 1; }
    .trophy { font-size: 1.5rem; }
    .loading { height: 0.5rem; background: #4c1d95; border-radius: 9999px; overflow: hidden; margin-top: 0.75rem; }
    .loading span { display: block; height: 100%; background: linear-gradient(90deg, #c4b5fd, #8b5cf6); width: 0%; transition: width 0.3s ease; }
    .review-item { border: 1px solid #a78bfa; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .review-item.correct { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
    .review-item.wrong { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
    @media (max-width: 640px) {
      nav { padding: 0.5rem; }
      #courses { font-size: 1rem; }
      .modal .card { width: 90%; }
      #course-select, #units-list button { font-size: 0.9rem; padding: 0.5rem; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">
  <div class="w-full flex items-center justify-center">
    <nav class="flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <img src="grape.png" alt="Grape Logo" class="w-8 h-8 rounded-full">
        <h1 id="courses" class="font-bold">Courses</h1>
        <span id="xp-display">0</span>
      </div>
      <div>
        <img id="settingsBtn" src="https://img.icons8.com/ios/512/7950F2/settings.png" alt="Settings" class="cursor-pointer">
      </div>
    </nav>
  </div>

  <div id="course-select-container" class="w-full max-w-5xl mt-4">
    <select id="course-select" name="course" class="w-full">
      <option value="" disabled selected>Select a Course</option>
    </select>
  </div>

  <div id="units-list" class="w-full max-w-5xl mt-2"></div>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal">
    <div class="card">
      <h2 class="text-xl font-bold mb-4">Settings</h2>
      <button id="reselectBtn" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-500 mb-3">Reselect AP Courses</button>
      <button id="logoutBtn" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600">Log Out</button>
      <button id="closeSettings" class="mt-3 text-purple-300 underline">Cancel</button>
    </div>
  </div>

  <!-- RESELECT MODAL -->
  <div id="reselectModal" class="modal">
    <div class="card max-w-2xl">
      <h2 class="text-xl font-bold mb-4">Reselect AP Courses</h2>
      <form id="reselectForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-96 overflow-y-auto mb-4"></form>
      <button id="saveReselect" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-500 mb-2">Save</button>
      <button id="closeReselect" class="w-full bg-gray-700 text-purple-300 py-2 rounded hover:bg-gray-600">Cancel</button>
    </div>
  </div>

  <!-- QUIZ MODAL (injected) -->
  <div id="quizModal" class="modal"></div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdOUtoPjAHyXoxBJPJvAVsveMuPA2vUSQ",
      authDomain: "grape-mcps.firebaseapp.com",
      projectId: "grape-mcps",
      storageBucket: "grape-mcps.firebasestorage.app",
      messagingSenderId: "909399056268",
      appId: "1:909399056268:web:3ac13a43d1e1846649c0a9",
      measurementId: "G-X2DELV9RFD"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    const els = {
      xp: document.getElementById("xp-display"),
      courseSel: document.getElementById("course-select"),
      units: document.getElementById("units-list"),
      settingsBtn: document.getElementById("settingsBtn"),
      settingsModal: document.getElementById("settingsModal"),
      reselectModal: document.getElementById("reselectModal"),
      reselectForm: document.getElementById("reselectForm"),
      saveReselect: document.getElementById("saveReselect"),
      closeReselect: document.getElementById("closeReselect"),
      closeSettings: document.getElementById("closeSettings"),
      logoutBtn: document.getElementById("logoutBtn"),
      reselectBtn: document.getElementById("reselectBtn")
    };

    const apCourses = {
      "AP African American Studies": ["Unit 1: Introduction to African American Studies"],
      "AP Art & Design: 2D": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art & Design: 3D": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art & Design: Drawing": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art History": [
        "Unit 1: Global Prehistoric Art, 30,000-500 BCE",
        "Unit 2: Ancient Mediterranean Art, 3500-300 BCE",
        "Unit 3: Early European and Colonial American Art, 200-1750 CE",
        "Unit 4: Later European and American Art, 1750-1980 CE",
        "Unit 5: Indigenous American Art, 1000 BCE-1980 CE",
        "Unit 6: African Art, 1100-1980 CE",
        "Unit 7: West and Central Asian Art, 500 BCE-1980 CE",
        "Unit 8: South, East, and Southeast Asian Art, 300 BCE-1980 CE",
        "Unit 9: Art in the Pacific, 700-1980 CE",
        "Unit 10: Global Contemporary Art, 1980 CE to Present"
      ],
      "AP Biology": [
        "Unit 1: Chemistry of Life",
        "Unit 2: Cell Structure and Function",
        "Unit 3: Cellular Energetics",
        "Unit 4: Cell Communication and Cell Cycle",
        "Unit 5: Heredity",
        "Unit 6: Gene Expression and Regulation",
        "Unit 7: Natural Selection",
        "Unit 8: Ecology"
      ],
      "AP Calculus AB": [
        "Unit 1: Limits and Continuity",
        "Unit 2: Differentiation - Definition and Fundamental Properties",
        "Unit 3: Differentiation - Composite, Implicit, and Inverse Functions",
        "Unit 4: Contextual Applications of Differentiation",
        "Unit 5: Analytical Applications of Differentiation",
        "Unit 6: Integration and Accumulation of Change",
        "Unit 7: Differential Equations",
        "Unit 8: Applications of Integration"
      ],
      "AP Calculus BC": [
        "Unit 1: Limits and Continuity",
        "Unit 2: Differentiation - Definition and Fundamental Properties",
        "Unit 3: Differentiation - Composite, Implicit, and Inverse Functions",
        "Unit 4: Contextual Applications of Differentiation",
        "Unit 5: Analytical Applications of Differentiation",
        "Unit 6: Integration and Accumulation of Change",
        "Unit 7: Differential Equations",
        "Unit 8: Applications of Integration",
        "Unit 9: Parametric Equations, Polar Coordinates, and Vector-Valued Functions",
        "Unit 10: Infinite Sequences and Series"
      ],
      "AP Chemistry": [
        "Unit 1: Atomic Structure and Properties",
        "Unit 2: Molecular and Ionic Bonding",
        "Unit 3: Intermolecular Forces and Properties",
        "Unit 4: Chemical Reactions",
        "Unit 5: Kinetics",
        "Unit 6: Thermodynamics",
        "Unit 7: Equilibrium",
        "Unit 8: Acids and Bases",
        "Unit 9: Applications of Thermodynamics"
      ],
      "AP Chinese": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Comparative Government": [
        "Unit 1: Political Systems, Regimes, and Governments",
        "Unit 2: Political Institutions",
        "Unit 3: Political Culture and Participation",
        "Unit 4: Party, Electoral Systems, and Citizen Organizations",
        "Unit 5: Political and Economic Changes and Development"
      ],
      "AP Computer Science A": [
        "Unit 1: Primitive Types",
        "Unit 2: Using Objects",
        "Unit 3: Boolean Expressions and If Statements",
        "Unit 4: Iteration",
        "Unit 5: Writing Classes",
        "Unit 6: Arrays",
        "Unit 7: ArrayLists",
        "Unit 8: 2D Arrays",
        "Unit 9: Inheritance",
        "Unit 10: Recursion"
      ],
      "AP Computer Science Principles": [
        "Unit 1: Creative Development",
        "Unit 2: Data",
        "Unit 3: Algorithms and Programming",
        "Unit 4: Computer Systems and Networks",
        "Unit 5: Impact of Computing"
      ],
      "AP English Language": [
        "Unit 1: Claims, Reasoning, and Evidence",
        "Unit 2: Organizing Information for a Specific Audience",
        "Unit 3: Perspectives and How Arguments Relate",
        "Unit 4: How Writers Develop Arguments, Intros, and Conclusions",
        "Unit 5: How a Writer Brings All Parts of an Argument Together",
        "Unit 6: Position, Perspective, and Bias",
        "Unit 7: Successful and Unsuccessful Arguments",
        "Unit 8: Stylistic Choices",
        "Unit 9: Developing a Complex Argument"
      ],
      "AP English Literature": [
        "Unit 1: Short Fiction I: Introduction to Short Fiction",
        "Unit 2: Poetry I: Introduction to Poetry",
        "Unit 3: Longer Fiction and Drama I: Introduction to Longer Fiction and Drama",
        "Unit 4: Short Fiction II: Character, Conflict, and Storytelling",
        "Unit 5: Poetry II: Structure and Figurative Language",
        "Unit 6: Longer Fiction or Drama II: Literary Techniques in Longer Works",
        "Unit 7: Short Fiction III: Societal and Historical Context",
        "Unit 8: Poetry III: Contrast, Ambiguous Language, and Other Techniques",
        "Unit 9: Longer Fiction or Drama III: Nuanced Analysis"
      ],
      "AP Environmental Science": [
        "Unit 1: The Living World: Ecosystems",
        "Unit 2: The Living World: Biodiversity",
        "Unit 3: Populations",
        "Unit 4: Earth Systems and Resources",
        "Unit 5: Land and Water Use",
        "Unit 6: Energy Resources and Consumption",
        "Unit 7: Atmospheric Pollution",
        "Unit 8: Aquatic and Terrestrial Pollution",
        "Unit 9: Global Change"
      ],
      "AP European History": [
        "Unit 1: Renaissance and Exploration",
        "Unit 2: Age of Reformation",
        "Unit 3: Absolutism and Constitutionalism",
        "Unit 4: Scientific, Philosophical, and Political Developments",
        "Unit 5: Conflict, Crisis, and Reaction in the Late 18th Century",
        "Unit 6: Industrialization and Its Effects",
        "Unit 7: 19th Century Perspectives and Political Developments",
        "Unit 8: 20th Century Global Conflicts",
        "Unit 9: Cold War and Contemporary Europe"
      ],
      "AP French": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP German": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Human Geography": [
        "Unit 1: Thinking Geographically",
        "Unit 2: Population and Migration Patterns and Processes",
        "Unit 3: Cultural Patterns and Processes",
        "Unit 4: Political Patterns and Processes",
        "Unit 5: Agriculture and Rural Land-Use Patterns and Processes",
        "Unit 6: Cities and Urban Land-Use",
        "Unit 7: Industrial and Economic Development Patterns and Processes"
      ],
      "AP Italian": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Japanese": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Latin": [
        "Unit 1: Vergil, Aeneid, Book 1",
        "Unit 2: Vergil, Aeneid, Book 2",
        "Unit 3: Vergil, Aeneid, Book 4",
        "Unit 4: Vergil, Aeneid, Book 6",
        "Unit 5: Catullus, Selected Poems",
        "Unit 6: Caesar, Selected Passages",
        "Unit 7: Cicero, Selected Speeches"
      ],
      "AP Macroeconomics": [
        "Unit 1: Basic Economic Concepts",
        "Unit 2: Economic Indicators and the Business Cycle",
        "Unit 3: National Income and Price Determination",
        "Unit 4: Financial Sector",
        "Unit 5: Long-Run Consequences of Stabilization Policies",
        "Unit 6: Open Economy - International Trade and Finance"
      ],
      "AP Microeconomics": [
        "Unit 1: Basic Economic Concepts",
        "Unit 2: Supply and Demand",
        "Unit 3: Production, Cost, and the Perfect Competition Model",
        "Unit 4: Imperfect Competition",
        "Unit 5: Factor Markets",
        "Unit 6: Market Failure and the Role of Government"
      ],
      "AP Music Theory": [
        "Unit 1: Music Fundamentals I",
        "Unit 2: Music Fundamentals II",
        "Unit 3: Music Fundamentals III",
        "Unit 4: Harmony and Voice Leading I",
        "Unit 5: Harmony and Voice Leading II",
        "Unit 6: Harmony and Voice Leading III",
        "Unit 7: Harmony and Voice Leading IV",
        "Unit 8: Modes and Form"
      ],
      "AP Physics 1": [
        "Unit 1: Kinematics",
        "Unit 2: Dynamics",
        "Unit 3: Circular Motion and Gravitation",
        "Unit 4: Energy",
        "Unit 5: Momentum",
        "Unit 6: Simple Harmonic Motion",
        "Unit 7: Torque and Rotational Motion"
      ],
      "AP Physics 2": [
        "Unit 1: Fluids",
        "Unit 2: Thermodynamics",
        "Unit 3: Electric Force, Field, and Potential",
        "Unit 4: Electric Circuits",
        "Unit 5: Magnetism and Electromagnetic Induction",
        "Unit 6: Geometric and Physical Optics",
        "Unit 7: Quantum, Atomic, and Nuclear Physics"
      ],
      "AP Physics C: Electricity & Magnetism": [
        "Unit 1: Electrostatics",
        "Unit 2: Conductors, Capacitors, Dielectrics",
        "Unit 3: Electric Circuits",
        "Unit 4: Magnetic Fields",
        "Unit 5: Electromagnetism"
      ],
      "AP Physics C: Mechanics": [
        "Unit 1: Kinematics",
        "Unit 2: Newton’s Laws of Motion",
        "Unit 3: Work, Energy, and Power",
        "Unit 4: Systems of Particles and Linear Momentum",
        "Unit 5: Rotation",
        "Unit 6: Oscillations",
        "Unit 7: Gravitation"
      ],
      "AP Pre-Calculus": [
        "Unit 1: Polynomial and Rational Functions",
        "Unit 2: Exponential and Logarithmic Functions",
        "Unit 3: Trigonometric and Polar Functions",
        "Unit 4: Functions Involving Parameters, Vectors, and Matrices"
      ],
      "AP Psychology": [
        "Unit 1: Scientific Foundations of Psychology",
        "Unit 2: Biological Basis of Behavior",
        "Unit 3: Sensation and Perception",
        "Unit 4: Learning",
        "Unit 5: Cognitive Psychology",
        "Unit 6: Developmental Psychology",
        "Unit 7: Motivation, Emotion, and Personality",
        "Unit 8: Clinical Psychology",
        "Unit 9: Social Psychology"
      ],
      "AP Research": [
        "Unit 1: Question and Explore",
        "Unit 2: Understand and Analyze",
        "Unit 3: Evaluate Multiple Perspectives",
        "Unit 4: Synthesize Ideas",
        "Unit 5: Team, Transform, and Transmit"
      ],
      "AP Seminar": [
        "Unit 1: Question and Explore",
        "Unit 2: Understand and Analyze",
        "Unit 3: Evaluate Multiple Perspectives",
        "Unit 4: Synthesize Ideas",
        "Unit 5: Team, Transform, and Transmit"
      ],
      "AP Spanish Language": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Spanish Literature": [
        "Unit 1: La época medieval",
        "Unit 2: El siglo XVI",
        "Unit 3: El siglo XVII",
        "Unit 4: La literatura romántica, realista y naturalista",
        "Unit 5: La Generación del 98 y el Modernismo",
        "Unit 6: Teatro y poesía del siglo XX",
        "Unit 7: El Boom latinoamericano",
        "Unit 8: Escritores contemporáneos de Estados Unidos, y España"
      ],
      "AP Statistics": [
        "Unit 1: Exploring One-Variable Data",
        "Unit 2: Exploring Two-Variable Data",
        "Unit 3: Collecting Data",
        "Unit 4: Probability, Random Variables, and Probability Distributions",
        "Unit 5: Sampling Distributions",
        "Unit 6: Inference for Categorical Data - Proportions",
        "Unit 7: Inference for Quantitative Data - Means",
        "Unit 8: Inference for Categorical Data - Chi-Squares",
        "Unit 9: Inference for Quantitative Data - Slopes"
      ],
      "AP US Government": [
        "Unit 1: Foundations of American Democracy",
        "Unit 2: Interactions Among Branches of Government",
        "Unit 3: Civil Liberties and Civil Rights",
        "Unit 4: American Political Ideologies and Beliefs",
        "Unit 5: Political Participation"
      ],
      "AP US History": [
        "Unit 1: 1491-1607 (Columbus to Jamestown)",
        "Unit 2: 1607-1754 (Colonial Society)",
        "Unit 3: 1754-1800 (American Revolution and Constitution)",
        "Unit 4: 1800-1848 (American Expansion)",
        "Unit 5: 1844-1877 (Civil War and Reconstruction)",
        "Unit 6: 1865-1898 (Gilded Age)",
        "Unit 7: 1898-1945 (Global Conflict)",
        "Unit 8: 1945-1980 (Cold War and Protest)",
        "Unit 9: 1980 to Present (Post-Cold War Shifts)"
      ],
      "AP World History: Modern": [
        "Unit 1: The Global Tapestry",
        "Unit 2: Networks of Exchange",
        "Unit 3: Land-Based Empires",
        "Unit 4: Transoceanic Interactions",
        "Unit 5: Revolutions",
        "Unit 6: Consequences of Industrialization",
        "Unit 7: Global Conflict",
        "Unit 8: Cold War and Decolonization",
        "Unit 9: Globalization"
      ]
    };

    const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyDNAAETxjKgPNYtH4kMu5rz0gvXad7UVwU`;

    const geminiJSON = async (prompt, schema) => {
      const res = await fetch(GEMINI_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ role: "user", parts: [{ text: prompt }] }],
          generationConfig: { response_mime_type: "application/json", response_schema: schema }
        })
      });
      if (!res.ok) throw new Error("Gemini error");
      const data = await res.json();
      return JSON.parse(data.candidates[0].content.parts[0].text);
    };

    const $ = (tag, cls, txt) => {
      const el = document.createElement(tag);
      if (cls) el.className = cls;
      if (txt) el.textContent = txt;
      return el;
    };

    const openModal = (id, html) => {
      const m = document.getElementById(id);
      m.innerHTML = html;
      m.classList.add('show');
    };

    const closeModal = (id) => {
      document.getElementById(id).classList.remove('show');
    };

    const loadingBar = () => {
      const bar = $('div', 'loading');
      const inner = $('span');
      bar.appendChild(inner);
      let progress = 0;
      const interval = setInterval(() => {
        progress = (progress + 10) % 100;
        inner.style.width = progress + '%';
      }, 150);
      return { bar, stop: () => clearInterval(interval), set: (p) => inner.style.width = p + '%' };
    };

    let userData = null;

    const renderCourses = (selected = [], progress = {}, xp = 0, trophies = { b: 0, s: 0, g: 0 }) => {
      els.xp.innerHTML = `${xp} <span class="trophy">${'Bronze '.repeat(trophies.b)}${'Silver '.repeat(trophies.s)}${'Gold '.repeat(trophies.g)}</span>`;
      els.courseSel.innerHTML = '<option value="" disabled selected>Select a Course</option>';
      els.units.innerHTML = '';
      if (!selected.length) { els.units.textContent = "No courses selected. Open settings."; return; }
      selected.forEach(c => { const opt = $('option', '', c); opt.value = c; els.courseSel.appendChild(opt); });
      els.courseSel.value = selected[0];
      renderUnits(selected[0], progress);
    };

    const renderUnits = (course, progress = {}) => {
      els.units.innerHTML = '';
      const units = apCourses[course] || [];
      units.forEach(unit => {
        const btn = $('button', '', unit);
        const chk = $('span', 'ml-2 text-green-400');
        if (progress[course]?.[unit]?.passed) chk.textContent = 'Checkmark';
        btn.appendChild(chk);
        btn.onclick = () => startQuiz(course, unit, chk, false);
        els.units.appendChild(btn);
      });
      const finalBtn = $('button', 'text-white', 'Final Exam');
      const fchk = $('span', 'ml-2 text-green-400');
      if (progress.finalExams?.[course]?.passed) fchk.textContent = 'Checkmark';
      finalBtn.appendChild(fchk);
      finalBtn.onclick = () => startQuiz(course, 'Final Exam', fchk, true);
      els.units.appendChild(finalBtn);
    };

    const startQuiz = async (course, unit, checkSpan, isFinal) => {
      openModal('quizModal', `<div class="card"><h2 class="text-xl font-bold mb-4">${course} — ${unit}</h2><div id="quizContent">Generating questions...<div class="loading mt-3"><span></span></div></div><button id="closeQuiz" class="mt-4 w-full bg-gray-700 text-purple-300 py-2 rounded hover:bg-gray-600">Close</button></div>`);
      document.getElementById('closeQuiz').onclick = () => closeModal('quizModal');
      const lb = loadingBar();
      document.querySelector('#quizContent .loading').appendChild(lb.bar);
      const questions = await generateQuiz(course, unit, isFinal, lb);
      lb.stop(); lb.set(100); setTimeout(() => document.querySelector('#quizContent .loading').remove(), 300);
      runQuiz(course, unit, questions, isFinal ? 20 : 5, isFinal ? 18 : 5, checkSpan, isFinal);
    };

    const generateQuiz = async (course, unit, isFinal, lb) => {
      const count = isFinal ? 20 : 5;
      const prompt = `Generate ${count} AP-style questions for ${course}, topic: ${unit}.\n${isFinal ? "16 MCQ, 2 source-analysis, 4 open-response." : "3 MCQ, 1 source-analysis, 1 open-response."}\nFor open-response: include rubric. Output JSON only.`;
      const schema = { type: "object", properties: { questions: { type: "array", items: { type: "object", properties: { type: { type: "string" }, question: { type: "string" }, source: { type: "string" }, choices: { type: "array", items: { type: "string" } }, correct: { type: "string" }, explanation: { type: "string" }, rubric: { type: "string" } } } } } };
      return (await geminiJSON(prompt, schema)).questions;
    };

    const runQuiz = (course, unit, questions, total, passThreshold, checkSpan, isFinal) => {
      let idx = 0, score = 0, xpEarned = 0, answers = [];
      const content = document.getElementById('quizContent');
      content.innerHTML = '';

      const nextQuestion = async () => {
        if (idx >= questions.length) {
          const passed = score >= passThreshold;
          const ref = doc(db, 'users', auth.currentUser.uid);
          let trophies = userData.trophies || { b: 0, s: 0, g: 0 };

          if (passed) {
            if (isFinal) {
              await setDoc(ref, { finalExams: { [course]: { passed: true, score } } }, { merge: true });
              const allUnitsPassed = Object.values(userData.progress?.[course] || {}).every(v => v.passed);
              if (allUnitsPassed && score === total) { trophies.g += 1; await setDoc(ref, { trophies }, { merge: true }); }
            } else {
              await setDoc(ref, { progress: { [course]: { [unit]: { passed: true, score } } } }, { merge: true });
              if (score === total) { trophies.b += 1; await setDoc(ref, { trophies }, { merge: true }); }
            }
            checkSpan.textContent = 'Checkmark';
          }

          const snap = await getDoc(ref);
          const curXP = snap.data()?.xp || 0;
          await updateDoc(ref, { xp: curXP + xpEarned });
          showGradingThenResult(course, unit, score, total, xpEarned, passed, answers, questions, isFinal);
          return;
        }

        const q = questions[idx];
        const card = $('div', 'border p-3 rounded mb-3');
        card.appendChild($('p', 'font-semibold text-white', q.question));
        if (q.source) card.appendChild($('p', 'italic mb-2 text-white', q.source));

        if (q.type === 'mcq' || q.type === 'source') {
          q.choices.forEach(ch => {
            const btn = $('button', 'block border rounded p-2 w-full mb-1 text-white', ch);
            btn.onclick = () => {
              answers.push({ q: q.question, a: ch, correct: ch === q.correct });
              if (ch === q.correct) { score++; xpEarned += 15; }
              idx++; nextQuestion();
            };
            card.appendChild(btn);
          });
        } else if (q.type === 'open') {
          const ta = document.createElement('textarea');
          ta.className = 'w-full border p-2 mb-2 text-white bg-violet-900';
          const submit = $('button', 'bg-purple-600 text-white px-3 py-1 rounded', 'Submit');
          submit.disabled = true;
          ta.oninput = () => submit.disabled = !ta.value.trim();
          submit.onclick = async () => {
            submit.disabled = true; submit.textContent = 'Grading...';
            const lb = loadingBar(); card.appendChild(lb.bar);
            const res = await gradeOpenResponse(course, unit, q.question, q.rubric, ta.value);
            lb.stop(); lb.set(100); setTimeout(() => lb.bar.remove(), 300);
            const pts = Math.min(4, Math.max(1, Math.round(res.score)));
            answers.push({ q: q.question, a: ta.value, pts, feedback: res.feedback });
            if (pts >= 3) { score++; xpEarned += 50; }
            idx++; nextQuestion();
          };
          card.appendChild(ta); card.appendChild(submit);
        }
        content.appendChild(card);
      };
      nextQuestion();
    };

    const gradeOpenResponse = async (course, unit, question, rubric, answer) => {
      const prompt = `Course: ${course}\nUnit: ${unit}\nQuestion: ${question}\nRubric: ${rubric}\nStudent answer:\n${answer}\nScore 1–4. Return JSON {score:number, feedback:string}.`;
      const schema = { type: "object", properties: { score: { type: "number" }, feedback: { type: "string" } } };
      return await geminiJSON(prompt, schema);
    };

    const showGradingThenResult = async (course, unit, score, total, xp, passed, answers, questions, isFinal) => {
      openModal('quizModal', `<div class="card"><h2 class="text-xl font-bold mb-4">Grading your answers...</h2><div class="loading mt-3"><span></span></div></div>`);
      const lb = loadingBar();
      document.querySelector('.loading').appendChild(lb.bar);
      await new Promise(r => setTimeout(r, 1800));
      lb.stop(); lb.set(100);
      setTimeout(() => {
        openModal('quizModal', `<div class="card"><h2 class="text-xl font-bold mb-2">${passed ? 'Passed' : 'Failed'} – ${score}/${total}</h2><p class="mb-4">XP Earned: +${xp}</p><button id="reviewBtn" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-500 mb-2">Review Answers</button><button id="closeResult" class="w-full bg-gray-700 text-purple-300 py-2 rounded hover:bg-gray-600">Close</button></div>`);
        document.getElementById('closeResult').onclick = () => closeModal('quizModal');
        document.getElementById('reviewBtn').onclick = () => showReviewModal(answers, questions);
      }, 400);
    };

    const showReviewModal = (answers, questions) => {
      let html = `<div class="card max-w-3xl"><h2 class="text-xl font-bold mb-4">Answer Review</h2><div class="max-h-96 overflow-y-auto space-y-3">`;
      answers.forEach((a, i) => {
        const q = questions[i];
        const cls = a.correct === true ? 'correct' : a.correct === false ? 'wrong' : '';
        html += `<div class="review-item ${cls}"><p class="font-semibold">${q.question}</p>`;
        if (q.source) html += `<p class="italic text-sm">${q.source}</p>`;
        if (a.correct !== undefined) {
          html += `<p class="${a.correct ? 'text-green-400' : 'text-red-400'}">${a.correct ? 'Correct' : 'Wrong'} – You chose: ${a.a}</p>`;
        } else {
          html += `<p class="text-yellow-300">Score: ${a.pts}/4</p><p class="text-sm">${a.feedback}</p>`;
        }
        html += `</div>`;
      });
      html += `</div><button id="closeReview" class="mt-4 w-full bg-gray-700 text-purple-300 py-2 rounded hover:bg-gray-600">Close</button></div>`;
      openModal('quizModal', html);
      document.getElementById('closeReview').onclick = () => closeModal('quizModal');
    };

    // Settings & Auth
    els.settingsBtn.onclick = () => openModal('settingsModal', document.querySelector('#settingsModal > div').outerHTML);
    els.closeSettings.onclick = () => closeModal('settingsModal');
    els.reselectBtn.onclick = () => { populateReselect(userData?.apCourses || []); openModal('reselectModal', document.querySelector('#reselectModal > div').outerHTML); };
    els.closeReselect.onclick = () => closeModal('reselectModal');
    els.saveReselect.onclick = async () => {
      const selected = Array.from(els.reselectForm.querySelectorAll('input:checked')).map(i => i.value);
      await setDoc(doc(db, 'users', auth.currentUser.uid), { apCourses: selected }, { merge: true });
      renderCourses(selected, userData?.progress || {}, userData?.xp || 0, userData?.trophies || { b: 0, s: 0, g: 0 });
      closeModal('reselectModal');
    };
    els.logoutBtn.onclick = async () => { await signOut(auth); location.href = 'index.html'; };

    const populateReselect = (selected = []) => {
      els.reselectForm.innerHTML = '';
      Object.keys(apCourses).forEach(c => {
        const label = $('label', 'flex items-center gap-2 p-2 rounded hover:bg-violet-800 cursor-pointer text-white');
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.value = c; if (selected.includes(c)) cb.checked = true;
        label.appendChild(cb); label.appendChild(document.createTextNode(c));
        els.reselectForm.appendChild(label);
      });
    };

    onAuthStateChanged(auth, async user => {
      if (!user) { setTimeout(() => location.href = 'index.html', 3000); return; }
      const ref = doc(db, 'users', user.uid);
      let snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, { apCourses: [], progress: {}, finalExams: {}, xp: 0, trophies: { b: 0, s: 0, g: 0 } });
      snap = await getDoc(ref);
      userData = snap.data();
      renderCourses(userData.apCourses, userData.progress, userData.xp, userData.trophies);
    });
  </script>
</body>
</html>
