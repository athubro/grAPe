<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Grape Classroom</title>
  <link rel="icon" type="image/png" href="grape.png" />
  <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
  --purple-50: #faf5ff;
  --purple-100: #f3e8ff;
  --purple-200: #e9d5ff;
  --purple-300: #d8b4fe;
  --purple-400: #c084fc;
  --purple-500: #a855f7;
  --purple-600: #9333ea;
  --purple-700: #7e22ce;
  --purple-800: #6b21a8;
  --purple-900: #581c87;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
}

body {
  min-height: 100vh;
  color: #1f2937;
  overflow-x: hidden;
  background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 50%, #e9d5ff 100%);
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(168, 85, 247, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(147, 51, 234, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 40% 20%, rgba(192, 132, 252, 0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
  animation: breathe 8s ease-in-out infinite;
}

@keyframes breathe {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

nav {
  width: 100%;
  padding: 1rem 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  backdrop-filter: blur(20px);
  position: sticky;
  top: 0;
  z-index: 40;
  background: rgba(250, 245, 255, 0.8);
  border-bottom: 1px solid rgba(168, 85, 247, 0.1);
  box-shadow: 0 1px 3px rgba(168, 85, 247, 0.05);
}

.nav-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

nav img.logo {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 0.75rem;
  box-shadow: 0 2px 8px rgba(168, 85, 247, 0.2);
}

#courses {
  font-size: 1.5rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--purple-600), var(--purple-800));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#xp-display {
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 600;
  background: linear-gradient(135deg, var(--purple-100), var(--purple-200));
  color: var(--purple-800);
  border: 1px solid var(--purple-300);
}

#settingsBtn {
  width: 2rem;
  height: 2rem;
  cursor: pointer;
  transition: all 0.3s ease;
  filter: brightness(0) saturate(100%) invert(39%) sepia(73%) saturate(4213%) hue-rotate(257deg) brightness(98%) contrast(94%);
}

#settingsBtn:hover {
  transform: scale(1.1);
}

.content {
  width: 100%;
  max-width: 80rem;
  margin: 0 auto;
  padding: 2rem 1.5rem;
  position: relative;
  z-index: 10;
}

#course-select-container {
  width: 100%;
  max-width: 48rem;
  margin: 0 auto 2rem;
}

#course-select {
  width: 100%;
  padding: 0.75rem 1rem;
  border-radius: 0.75rem;
  font-weight: 500;
  font-size: 1rem;
  color: #1f2937;
  cursor: pointer;
  transition: all 0.2s ease;
  background: white;
  border: 2px solid var(--purple-200);
  box-shadow: 0 2px 8px rgba(168, 85, 247, 0.08);
}

#course-select:hover {
  border-color: var(--purple-400);
  box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15);
}

#course-select:focus {
  outline: none;
  border-color: var(--purple-500);
  box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
}

#units-list {
  width: 100%;
  max-width: 64rem;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
}

#units-list button {
  width: 100%;
  padding: 1rem 1.5rem;
  border-radius: 0.75rem;
  font-weight: 500;
  font-size: 1rem;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: white;
  color: var(--purple-900);
  border: 2px solid var(--purple-200);
  box-shadow: 0 2px 8px rgba(168, 85, 247, 0.06);
  cursor: pointer;
  text-align: left;
}

#units-list button:hover {
  transform: translateY(-4px);
  background: linear-gradient(135deg, white, var(--purple-50));
  border-color: var(--purple-400);
  box-shadow: 0 8px 20px rgba(168, 85, 247, 0.15);
}

#units-list button:active {
  transform: scale(0.95);
}

#units-list button .check {
  margin-left: 0.5rem;
  color: #22c55e;
}

.modal-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50;
  background: rgba(59, 7, 100, 0.4);
  backdrop-filter: blur(12px);
  opacity: 1;
  transition: opacity 0.3s ease;
}

.modal-overlay.hidden {
  display: none;
  opacity: 0;
  pointer-events: none;
}

.modal-content {
  padding: 2rem;
  border-radius: 1.5rem;
  max-width: 32rem;
  width: 90%;
  margin: 1rem;
  background: white;
  border: 2px solid var(--purple-200);
  box-shadow: 0 25px 50px rgba(168, 85, 247, 0.2);
  animation: modal-in 0.3s ease-out;
}

.modal-content.large {
  max-width: 42rem;
}

@keyframes modal-in {
  from { 
    transform: scale(0.95) translateY(-20px); 
    opacity: 0; 
  }
  to { 
    transform: scale(1) translateY(0); 
    opacity: 1; 
  }
}

.modal-content h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 1.5rem;
  color: var(--purple-900);
}

.modal-btn {
  width: 100%;
  padding: 0.75rem 1.5rem;
  border-radius: 0.75rem;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.2s ease;
  border: none;
  cursor: pointer;
  background: linear-gradient(135deg, var(--purple-600), var(--purple-800));
  color: white;
  margin-bottom: 0.75rem;
}

.modal-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(168, 85, 247, 0.3);
}

.modal-btn:active {
  transform: scale(0.95);
}

.modal-btn.secondary {
  background: var(--purple-100);
  color: var(--purple-700);
  border: 1px solid var(--purple-200);
  margin-top: 0.75rem;
  margin-bottom: 0;
}

.modal-btn.secondary:hover {
  background: var(--purple-200);
  border-color: var(--purple-300);
  box-shadow: none;
}

.modal-btn.danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
}

.modal-btn.danger:hover {
  box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
}

#reselectForm {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
  max-height: 24rem;
  overflow-y: auto;
  margin-bottom: 1rem;
  padding-right: 0.5rem;
}

#reselectForm label {
  display: flex;
  align-items: center;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  padding: 0.5rem 0.75rem;
  border-radius: 0.5rem;
  color: var(--purple-800);
}

#reselectForm label:hover {
  background: var(--purple-50);
}

#reselectForm input[type="checkbox"] {
  width: 1.25rem;
  height: 1.25rem;
  border-radius: 0.25rem;
  margin-right: 0.75rem;
  cursor: pointer;
  appearance: none;
  background: white;
  border: 2px solid var(--purple-300);
  transition: all 0.2s ease;
  position: relative;
}

#reselectForm input[type="checkbox"]:checked {
  background: linear-gradient(135deg, var(--purple-600), var(--purple-800));
  border-color: var(--purple-600);
}

#reselectForm input[type="checkbox"]:checked::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 0.875rem;
  font-weight: 700;
}

#reselectForm input[type="checkbox"]:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
}

#quizContent {
  margin-bottom: 1rem;
}

#quizContent .question-card {
  border-radius: 0.75rem;
  padding: 1rem;
  margin-bottom: 1rem;
  background: var(--purple-50);
  border: 2px solid var(--purple-200);
}

#quizContent .question-text {
  font-weight: 600;
  margin-bottom: 1rem;
  color: #1f2937;
}

#quizContent .source-text {
  font-style: italic;
  margin-bottom: 1rem;
  color: #4b5563;
}

#quizContent .choice-btn {
  width: 100%;
  padding: 0.75rem 1rem;
  margin-bottom: 0.5rem;
  border-radius: 0.5rem;
  text-align: left;
  background: white;
  color: var(--purple-800);
  border: 1px solid var(--purple-300);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.95rem;
}

#quizContent .choice-btn:hover {
  background: var(--purple-100);
  border-color: var(--purple-400);
}

#quizContent textarea {
  width: 100%;
  padding: 1rem;
  border-radius: 0.75rem;
  color: var(--purple-900);
  background: var(--purple-50);
  border: 2px solid var(--purple-200);
  resize: vertical;
  min-height: 120px;
  font-size: 1rem;
  font-family: inherit;
  transition: all 0.2s ease;
}

#quizContent textarea:focus {
  outline: none;
  border-color: var(--purple-500);
  box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
  background: white;
}

#quizContent textarea::placeholder {
  color: #9ca3af;
}

#quizContent .submit-btn {
  background: linear-gradient(135deg, var(--purple-600), var(--purple-800));
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 0.75rem;
  border: none;
  cursor: pointer;
  font-weight: 600;
  margin-top: 0.5rem;
  transition: all 0.2s ease;
}

#quizContent .submit-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(168, 85, 247, 0.3);
}

#quizContent .submit-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#quizContent .result-text {
  color: #1f2937;
  font-size: 1.125rem;
  margin-bottom: 0.5rem;
}

.loading-spinner {
  display: inline-block;
  width: 1.5rem;
  height: 1.5rem;
  border: 3px solid var(--purple-200);
  border-top: 3px solid var(--purple-600);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 1rem auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-container {
  text-align: center;
  padding: 2rem;
}

::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: var(--purple-100);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: var(--purple-400);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--purple-500);
}

::selection {
  background: var(--purple-200);
  color: var(--purple-900);
}

button:focus-visible, 
input:focus-visible, 
select:focus-visible {
  outline: 2px solid var(--purple-500);
  outline-offset: 2px;
}

html {
  scroll-behavior: smooth;
}

@keyframes fade-in {
  from { 
    opacity: 0; 
    transform: translateY(10px);
  }
  to { 
    opacity: 1; 
    transform: translateY(0);
  }
}

#units-list button {
  animation: fade-in 0.3s ease-out;
}

@media (max-width: 768px) {
  nav {
    padding: 0.75rem 1rem;
  }

  #courses {
    font-size: 1.25rem;
  }

  .content {
    padding: 1.5rem 1rem;
  }

  #units-list {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  .modal-content {
    max-width: 100%;
    margin: 0.75rem;
    padding: 1.5rem;
  }

  #reselectForm {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 640px) {
  .nav-left {
    gap: 0.5rem;
  }

  nav img.logo {
    width: 2rem;
    height: 2rem;
  }

  #courses {
    font-size: 1.125rem;
  }

  #xp-display {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
  }
}
  </style>
</head>
<body>
  <nav>
    <div class="nav-left">
      <img src="grape.png" alt="Grape Logo" class="logo">
      <h1 id="courses">Courses</h1>
      <span id="xp-display">0</span>
    </div>
    <div>
      <img id="settingsBtn" src="https://img.icons8.com/ios11/512/7950F2/settings.png" alt="Settings">
    </div>
  </nav>

  <div class="content">
    <div id="course-select-container">
      <select id="course-select">
        <option value="" disabled>Select a Course</option>
      </select>
    </div>

    <div id="units-list"></div>
  </div>

  <div id="settingsModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>Settings</h2>
      <button id="reselectBtn" class="modal-btn">Reselect AP Courses</button>
      <button id="logoutBtn" class="modal-btn danger">Log Out</button>
      <button id="closeSettings" class="modal-btn secondary">Cancel</button>
    </div>
  </div>

  <div id="reselectModal" class="modal-overlay hidden">
    <div class="modal-content large">
      <h2>Reselect AP Courses</h2>
      <form id="reselectForm"></form>
      <button id="saveReselect" class="modal-btn">Save</button>
      <button id="closeReselect" class="modal-btn secondary">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      setPersistence, 
      browserLocalPersistence, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdOUtoPjAHyXoxBJPJvAVsveMuPA2vUSQ",
      authDomain: "grape-mcps.firebaseapp.com",
      projectId: "grape-mcps",
      storageBucket: "grape-mcps.firebasestorage.app",
      messagingSenderId: "909399056268",
      appId: "1:909399056268:web:3ac13a43d1e1846649c0a9",
      measurementId: "G-X2DELV9RFD"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    await setPersistence(auth, browserLocalPersistence);

    // ============================================
    // OLLAMA CONFIGURATION
    // ============================================
    // CHANGE THIS to your ngrok URL (without the trailing slash)
    const OLLAMA_URL = "https://tamara-postmyxedemic-manuela.ngrok-free.dev";
    const OLLAMA_MODEL = "llama3.2";

    // Test Ollama connection on page load
    async function testOllamaConnection() {
      try {
        const response = await fetch(`${OLLAMA_URL}/api/tags`, {
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Ollama connected. Available models:', data.models.map(m => m.name));
          return true;
        } else {
          console.error('‚ùå Ollama responded with error:', response.status);
          return false;
        }
      } catch (error) {
        console.error('‚ùå Ollama connection failed:', error);
        
        // Check if it's a CORS error
        if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
          console.error('üö® CORS ERROR DETECTED!');
          console.log('');
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('HOW TO FIX:');
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('');
          console.log('Option 1: Set OLLAMA_ORIGINS environment variable');
          console.log('  Windows PowerShell:');
          console.log('    $env:OLLAMA_ORIGINS="*"');
          console.log('    ollama serve');
          console.log('');
          console.log('  Mac/Linux:');
          console.log('    export OLLAMA_ORIGINS="*"');
          console.log('    ollama serve');
          console.log('');
          console.log('Option 2: Use a local web server (RECOMMENDED)');
          console.log('  python -m http.server 8000');
          console.log('  Then open: http://localhost:8000/dashboard-ollama-final.html');
          console.log('');
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          
          // Show alert to user
          alert('‚ö†Ô∏è CORS Error Detected!\n\nOllama is running, but your browser is blocking the connection.\n\nSolution: Serve this HTML file using a local web server.\n\nRun this command in your terminal:\n\npython -m http.server 8000\n\nThen open:\nhttp://localhost:8000/dashboard-ollama-final.html\n\nSee console (F12) for more details.');
        }
        
        return false;
      }
    }

    // Call Ollama API
    async function callOllama(prompt) {
      try {
        const response = await fetch(`${OLLAMA_URL}/api/generate`, {
          method: 'POST',
          mode: 'cors',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: OLLAMA_MODEL,
            prompt: prompt,
            stream: false,
            options: {
              temperature: 0.7,
              num_predict: 2000
            }
          })
        });

        if (!response.ok) {
          throw new Error(`Ollama API error: ${response.status}`);
        }

        const data = await response.json();
        return data.response;
      } catch (error) {
        if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
          throw new Error('CORS error - Please serve this file using a local web server (see console for instructions)');
        }
        console.error('Ollama API call failed:', error);
        throw error;
      }
    }

    // Parse JSON from Ollama response
    function parseJSON(text) {
      // Try to find JSON in the response
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        try {
          return JSON.parse(jsonMatch[0]);
        } catch (e) {
          console.error('JSON parse error:', e);
        }
      }
      
      // Try the full text
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('Failed to parse JSON from response:', text);
        throw new Error('Could not parse JSON from model response');
      }
    }

    // ============================================
    // QUIZ GENERATION WITH OLLAMA
    // ============================================
    async function generateQuiz(course, unit, isFinal = false) {
      const count = isFinal ? 20 : 5;
      const mcqCount = isFinal ? 16 : 3;
      const sourceCount = isFinal ? 2 : 1;
      const openCount = isFinal ? 4 : 1;

      const prompt = `You are an expert AP teacher creating quiz questions for ${course}, ${unit}.

Generate EXACTLY ${count} questions in valid JSON format with this structure:
{
  "questions": [
    {
      "type": "mcq",
      "question": "Question text here?",
      "choices": ["A) Option 1", "B) Option 2", "C) Option 3", "D) Option 4"],
      "correct": "A) Option 1",
      "explanation": "Why this is correct"
    }
  ]
}

Requirements:
- ${mcqCount} multiple choice questions (type: "mcq")
- ${sourceCount} source-analysis questions (type: "source", includes "source" field with text to analyze)
- ${openCount} open-response questions (type: "open", includes "rubric" field instead of choices/correct/explanation)

For MCQ and source questions: Include exactly 4 choices, the correct answer, and an explanation.
For open-response: Include a detailed rubric for grading.

Return ONLY valid JSON, no other text.`;

      try {
        const response = await callOllama(prompt);
        const data = parseJSON(response);
        
        if (!data.questions || !Array.isArray(data.questions)) {
          throw new Error('Invalid response format');
        }

        // Validate questions
        const validQuestions = data.questions.filter(q => {
          if (!q || !q.question || !q.type) return false;
          
          if (q.type === 'mcq' || q.type === 'source') {
            return Array.isArray(q.choices) && 
                   q.choices.length === 4 && 
                   q.correct && 
                   q.explanation;
          } else if (q.type === 'open') {
            return q.rubric && q.rubric.trim() !== '';
          }
          return false;
        });

        if (validQuestions.length === 0) {
          throw new Error('No valid questions generated');
        }

        console.log(`‚úÖ Generated ${validQuestions.length} valid questions`);
        return validQuestions;

      } catch (error) {
        console.error('Quiz generation error:', error);
        throw new Error(`Failed to generate quiz: ${error.message}`);
      }
    }

    // ============================================
    // GRADING OPEN RESPONSE WITH OLLAMA
    // ============================================
    async function gradeOpenResponse(course, unit, question, rubric, userAnswer) {
      const prompt = `You are grading an AP ${course} student response for ${unit}.

Question: ${question}

Rubric: ${rubric}

Student Answer: ${userAnswer}

Evaluate if the student's answer meets the rubric criteria. Return ONLY valid JSON:
{
  "pass": true or false,
  "feedback": "Brief feedback explaining the grade"
}

Return ONLY the JSON, no other text.`;

      try {
        const response = await callOllama(prompt);
        const data = parseJSON(response);
        
        if (typeof data.pass !== 'boolean' || !data.feedback) {
          throw new Error('Invalid grading response format');
        }
        
        return data;
      } catch (error) {
        console.error('Grading error:', error);
        throw new Error(`Failed to grade response: ${error.message}`);
      }
    }

    // Test connection when page loads
    testOllamaConnection();

    // ============================================
    // UI AND FIREBASE CODE
    // ============================================
    const courses = document.getElementById("courses");
    const xpDisplay = document.getElementById("xp-display");
    const courseSelect = document.getElementById("course-select");
    const unitsList = document.getElementById("units-list");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsModal = document.getElementById("settingsModal");
    const closeSettings = document.getElementById("closeSettings");
    const logoutBtn = document.getElementById("logoutBtn");
    const reselectBtn = document.getElementById("reselectBtn");
    const reselectModal = document.getElementById("reselectModal");
    const reselectForm = document.getElementById("reselectForm");
    const saveReselect = document.getElementById("saveReselect");
    const closeReselect = document.getElementById("closeReselect");

    const apCourses = {
      "AP African American Studies": ["Unit 1: Introduction to African American Studies"],
      "AP Art & Design: 2D": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art & Design: 3D": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art & Design: Drawing": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art History": [
        "Unit 1: Global Prehistoric Art, 30,000-500 BCE",
        "Unit 2: Ancient Mediterranean Art, 3500-300 BCE",
        "Unit 3: Early European and Colonial American Art, 200-1750 CE",
        "Unit 4: Later European and American Art, 1750-1980 CE",
        "Unit 5: Indigenous American Art, 1000 BCE-1980 CE",
        "Unit 6: African Art, 1100-1980 CE",
        "Unit 7: West and Central Asian Art, 500 BCE-1980 CE",
        "Unit 8: South, East, and Southeast Asian Art, 300 BCE-1980 CE",
        "Unit 9: Art in the Pacific, 700-1980 CE",
        "Unit 10: Global Contemporary Art, 1980 CE to Present"
      ],
      "AP Biology": [
        "Unit 1: Chemistry of Life",
        "Unit 2: Cell Structure and Function",
        "Unit 3: Cellular Energetics",
        "Unit 4: Cell Communication and Cell Cycle",
        "Unit 5: Heredity",
        "Unit 6: Gene Expression and Regulation",
        "Unit 7: Natural Selection",
        "Unit 8: Ecology"
      ],
      "AP Calculus AB": [
        "Unit 1: Limits and Continuity",
        "Unit 2: Differentiation - Definition and Fundamental Properties",
        "Unit 3: Differentiation - Composite, Implicit, and Inverse Functions",
        "Unit 4: Contextual Applications of Differentiation",
        "Unit 5: Analytical Applications of Differentiation",
        "Unit 6: Integration and Accumulation of Change",
        "Unit 7: Differential Equations",
        "Unit 8: Applications of Integration"
      ],
      "AP Calculus BC": [
        "Unit 1: Limits and Continuity",
        "Unit 2: Differentiation - Definition and Fundamental Properties",
        "Unit 3: Differentiation - Composite, Implicit, and Inverse Functions",
        "Unit 4: Contextual Applications of Differentiation",
        "Unit 5: Analytical Applications of Differentiation",
        "Unit 6: Integration and Accumulation of Change",
        "Unit 7: Differential Equations",
        "Unit 8: Applications of Integration",
        "Unit 9: Parametric Equations, Polar Coordinates, and Vector-Valued Functions",
        "Unit 10: Infinite Sequences and Series"
      ],
      "AP Chemistry": [
        "Unit 1: Atomic Structure and Properties",
        "Unit 2: Molecular and Ionic Bonding",
        "Unit 3: Intermolecular Forces and Properties",
        "Unit 4: Chemical Reactions",
        "Unit 5: Kinetics",
        "Unit 6: Thermodynamics",
        "Unit 7: Equilibrium",
        "Unit 8: Acids and Bases",
        "Unit 9: Applications of Thermodynamics"
      ],
      "AP Chinese": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Comparative Government": [
        "Unit 1: Political Systems, Regimes, and Governments",
        "Unit 2: Political Institutions",
        "Unit 3: Political Culture and Participation",
        "Unit 4: Party, Electoral Systems, and Citizen Organizations",
        "Unit 5: Political and Economic Changes and Development"
      ],
      "AP Computer Science A": [
        "Unit 1: Primitive Types",
        "Unit 2: Using Objects",
        "Unit 3: Boolean Expressions and If Statements",
        "Unit 4: Iteration",
        "Unit 5: Writing Classes",
        "Unit 6: Arrays",
        "Unit 7: ArrayLists",
        "Unit 8: 2D Arrays",
        "Unit 9: Inheritance",
        "Unit 10: Recursion"
      ],
      "AP Computer Science Principles": [
        "Unit 1: Creative Development",
        "Unit 2: Data",
        "Unit 3: Algorithms and Programming",
        "Unit 4: Computer Systems and Networks",
        "Unit 5: Impact of Computing"
      ],
      "AP English Language": [
        "Unit 1: Claims, Reasoning, and Evidence",
        "Unit 2: Organizing Information for a Specific Audience",
        "Unit 3: Perspectives and How Arguments Relate",
        "Unit 4: How Writers Develop Arguments, Intros, and Conclusions",
        "Unit 5: How a Writer Brings All Parts of an Argument Together",
        "Unit 6: Position, Perspective, and Bias",
        "Unit 7: Successful and Unsuccessful Arguments",
        "Unit 8: Stylistic Choices",
        "Unit 9: Developing a Complex Argument"
      ],
      "AP English Literature": [
        "Unit 1: Short Fiction I: Introduction to Short Fiction",
        "Unit 2: Poetry I: Introduction to Poetry",
        "Unit 3: Longer Fiction and Drama I: Introduction to Longer Fiction and Drama",
        "Unit 4: Short Fiction II: Character, Conflict, and Storytelling",
        "Unit 5: Poetry II: Structure and Figurative Language",
        "Unit 6: Longer Fiction or Drama II: Literary Techniques in Longer Works",
        "Unit 7: Short Fiction III: Societal and Historical Context",
        "Unit 8: Poetry III: Contrast, Ambiguous Language, and Other Techniques",
        "Unit 9: Longer Fiction or Drama III: Nuanced Analysis"
      ],
      "AP Environmental Science": [
        "Unit 1: The Living World: Ecosystems",
        "Unit 2: The Living World: Biodiversity",
        "Unit 3: Populations",
        "Unit 4: Earth Systems and Resources",
        "Unit 5: Land and Water Use",
        "Unit 6: Energy Resources and Consumption",
        "Unit 7: Atmospheric Pollution",
        "Unit 8: Aquatic and Terrestrial Pollution",
        "Unit 9: Global Change"
      ],
      "AP European History": [
        "Unit 1: Renaissance and Exploration",
        "Unit 2: Age of Reformation",
        "Unit 3: Absolutism and Constitutionalism",
        "Unit 4: Scientific, Philosophical, and Political Developments",
        "Unit 5: Conflict, Crisis, and Reaction in the Late 18th Century",
        "Unit 6: Industrialization and Its Effects",
        "Unit 7: 19th Century Perspectives and Political Developments",
        "Unit 8: 20th Century Global Conflicts",
        "Unit 9: Cold War and Contemporary Europe"
      ],
      "AP French": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP German": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Human Geography": [
        "Unit 1: Thinking Geographically",
        "Unit 2: Population and Migration Patterns and Processes",
        "Unit 3: Cultural Patterns and Processes",
        "Unit 4: Political Patterns and Processes",
        "Unit 5: Agriculture and Rural Land-Use Patterns and Processes",
        "Unit 6: Cities and Urban Land-Use",
        "Unit 7: Industrial and Economic Development Patterns and Processes"
      ],
      "AP Italian": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Japanese": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Latin": [
        "Unit 1: Vergil, Aeneid, Book 1",
        "Unit 2: Vergil, Aeneid, Book 2",
        "Unit 3: Vergil, Aeneid, Book 4",
        "Unit 4: Vergil, Aeneid, Book 6",
        "Unit 5: Catullus, Selected Poems",
        "Unit 6: Caesar, Selected Passages",
        "Unit 7: Cicero, Selected Speeches"
      ],
      "AP Macroeconomics": [
        "Unit 1: Basic Economic Concepts",
        "Unit 2: Economic Indicators and the Business Cycle",
        "Unit 3: National Income and Price Determination",
        "Unit 4: Financial Sector",
        "Unit 5: Long-Run Consequences of Stabilization Policies",
        "Unit 6: Open Economy - International Trade and Finance"
      ],
      "AP Microeconomics": [
        "Unit 1: Basic Economic Concepts",
        "Unit 2: Supply and Demand",
        "Unit 3: Production, Cost, and the Perfect Competition Model",
        "Unit 4: Imperfect Competition",
        "Unit 5: Factor Markets",
        "Unit 6: Market Failure and the Role of Government"
      ],
      "AP Music Theory": [
        "Unit 1: Music Fundamentals I",
        "Unit 2: Music Fundamentals II",
        "Unit 3: Music Fundamentals III",
        "Unit 4: Harmony and Voice Leading I",
        "Unit 5: Harmony and Voice Leading II",
        "Unit 6: Harmony and Voice Leading III",
        "Unit 7: Harmony and Voice Leading IV",
        "Unit 8: Modes and Form"
      ],
      "AP Physics 1": [
        "Unit 1: Kinematics",
        "Unit 2: Dynamics",
        "Unit 3: Circular Motion and Gravitation",
        "Unit 4: Energy",
        "Unit 5: Momentum",
        "Unit 6: Simple Harmonic Motion",
        "Unit 7: Torque and Rotational Motion"
      ],
      "AP Physics 2": [
        "Unit 1: Fluids",
        "Unit 2: Thermodynamics",
        "Unit 3: Electric Force, Field, and Potential",
        "Unit 4: Electric Circuits",
        "Unit 5: Magnetism and Electromagnetic Induction",
        "Unit 6: Geometric and Physical Optics",
        "Unit 7: Quantum, Atomic, and Nuclear Physics"
      ],
      "AP Physics C: Electricity & Magnetism": [
        "Unit 1: Electrostatics",
        "Unit 2: Conductors, Capacitors, Dielectrics",
        "Unit 3: Electric Circuits",
        "Unit 4: Magnetic Fields",
        "Unit 5: Electromagnetism"
      ],
      "AP Physics C: Mechanics": [
        "Unit 1: Kinematics",
        "Unit 2: Newton's Laws of Motion",
        "Unit 3: Work, Energy, and Power",
        "Unit 4: Systems of Particles and Linear Momentum",
        "Unit 5: Rotation",
        "Unit 6: Oscillations",
        "Unit 7: Gravitation"
      ],
      "AP Pre-Calculus": [
        "Unit 1: Polynomial and Rational Functions",
        "Unit 2: Exponential and Logarithmic Functions",
        "Unit 3: Trigonometric and Polar Functions",
        "Unit 4: Functions Involving Parameters, Vectors, and Matrices"
      ],
      "AP Psychology": [
        "Unit 1: Scientific Foundations of Psychology",
        "Unit 2: Biological Basis of Behavior",
        "Unit 3: Sensation and Perception",
        "Unit 4: Learning",
        "Unit 5: Cognitive Psychology",
        "Unit 6: Developmental Psychology",
        "Unit 7: Motivation, Emotion, and Personality",
        "Unit 8: Clinical Psychology",
        "Unit 9: Social Psychology"
      ],
      "AP Research": [
        "Unit 1: Question and Explore",
        "Unit 2: Understand and Analyze",
        "Unit 3: Evaluate Multiple Perspectives",
        "Unit 4: Synthesize Ideas",
        "Unit 5: Team, Transform, and Transmit"
      ],
      "AP Seminar": [
        "Unit 1: Question and Explore",
        "Unit 2: Understand and Analyze",
        "Unit 3: Evaluate Multiple Perspectives",
        "Unit 4: Synthesize Ideas",
        "Unit 5: Team, Transform, and Transmit"
      ],
      "AP Spanish Language": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Spanish Literature": [
        "Unit 1: La √©poca medieval",
        "Unit 2: El siglo XVI",
        "Unit 3: El siglo XVII",
        "Unit 4: La literatura rom√°ntica, realista y naturalista",
        "Unit 5: La Generaci√≥n del 98 y el Modernismo",
        "Unit 6: Teatro y poes√≠a del siglo XX",
        "Unit 7: El Boom latinoamericano",
        "Unit 8: Escritores contempor√°neos de Estados Unidos, y Espa√±a"
      ],
      "AP Statistics": [
        "Unit 1: Exploring One-Variable Data",
        "Unit 2: Exploring Two-Variable Data",
        "Unit 3: Collecting Data",
        "Unit 4: Probability, Random Variables, and Probability Distributions",
        "Unit 5: Sampling Distributions",
        "Unit 6: Inference for Categorical Data - Proportions",
        "Unit 7: Inference for Quantitative Data - Means",
        "Unit 8: Inference for Categorical Data - Chi-Squares",
        "Unit 9: Inference for Quantitative Data - Slopes"
      ],
      "AP US Government": [
        "Unit 1: Foundations of American Democracy",
        "Unit 2: Interactions Among Branches of Government",
        "Unit 3: Civil Liberties and Civil Rights",
        "Unit 4: American Political Ideologies and Beliefs",
        "Unit 5: Political Participation"
      ],
      "AP US History": [
        "Unit 1: 1491-1607 (Columbus to Jamestown)",
        "Unit 2: 1607-1754 (Colonial Society)",
        "Unit 3: 1754-1800 (American Revolution and Constitution)",
        "Unit 4: 1800-1848 (American Expansion)",
        "Unit 5: 1844-1877 (Civil War and Reconstruction)",
        "Unit 6: 1865-1898 (Gilded Age)",
        "Unit 7: 1898-1945 (Global Conflict)",
        "Unit 8: 1945-1980 (Cold War and Protest)",
        "Unit 9: 1980 to Present (Post-Cold War Shifts)"
      ],
      "AP World History: Modern": [
        "Unit 1: The Global Tapestry",
        "Unit 2: Networks of Exchange",
        "Unit 3: Land-Based Empires",
        "Unit 4: Transoceanic Interactions",
        "Unit 5: Revolutions",
        "Unit 6: Consequences of Industrialization",
        "Unit 7: Global Conflict",
        "Unit 8: Cold War and Decolonization",
        "Unit 9: Globalization"
      ]
    };

    function createEl(tag, className, text) {
      const el = document.createElement(tag);
      if (className) el.className = className;
      if (text) el.textContent = text;
      return el;
    }

    function renderAPCoursesForUser(selected, progressDoc = {}, xp = 0) {
      courseSelect.innerHTML = '<option value="" disabled>Select a Course</option>';
      unitsList.innerHTML = '';

      xpDisplay.textContent = `${xp}`;

      if (!selected || selected.length === 0) {
        unitsList.textContent = "No courses selected. Open settings to select courses.";
        unitsList.style.color = '#4b5563';
        return;
      }

      selected.forEach(courseName => {
        const option = createEl('option', '', courseName);
        option.value = courseName;
        courseSelect.appendChild(option);
      });

      if (selected.length > 0) {
        courseSelect.value = selected[0];
        renderUnits(selected[0], progressDoc);
      }

      courseSelect.addEventListener('change', () => {
        const selectedCourse = courseSelect.value;
        renderUnits(selectedCourse, progressDoc);
      });
    }

    function renderUnits(courseName, progressDoc = {}) {
      unitsList.innerHTML = '';
      const units = apCourses[courseName];
      if (!units) {
        unitsList.textContent = 'No units available for this course.';
        unitsList.style.color = '#4b5563';
        return;
      }

      units.forEach(unit => {
        const unitBtn = createEl('button', '', unit);
        const check = createEl('span', 'check');
        if (progressDoc?.[courseName]?.[unit]?.passed) check.textContent = '‚úÖ';
        unitBtn.appendChild(check);
        unitBtn.addEventListener('click', () => openUnitQuiz(courseName, unit, check));
        unitsList.appendChild(unitBtn);
      });

      const finalBtn = createEl('button', '', 'Final Exam');
      const finalCheck = createEl('span', 'check');
      if (progressDoc?.finalExams?.[courseName]?.passed) finalCheck.textContent = '‚úÖ';
      finalBtn.appendChild(finalCheck);
      finalBtn.addEventListener('click', () => openFinalExam(courseName, finalCheck));
      unitsList.appendChild(finalBtn);
    }

    async function openUnitQuiz(course, unit, checkSpan) {
      const modal = createEl('div', 'modal-overlay');
      modal.id = 'quizModal';
      
      const content = createEl('div', 'modal-content large');
      const title = createEl('h2', '', `${course} ‚Äî ${unit}`);
      const quizContent = createEl('div');
      quizContent.id = 'quizContent';
      
      const startBtn = createEl('button', 'modal-btn', 'Start');
      startBtn.id = 'startQuiz';
      quizContent.appendChild(startBtn);
      
      const closeBtn = createEl('button', 'modal-btn secondary', 'Close');
      closeBtn.id = 'closeQuiz';
      
      content.appendChild(title);
      content.appendChild(quizContent);
      content.appendChild(closeBtn);
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      closeBtn.onclick = () => modal.remove();

      startBtn.onclick = async () => {
        quizContent.innerHTML = '<div class="loading-container"><p style="color: var(--purple-800); font-weight: 600;">Generating quiz with Ollama...</p><div class="loading-spinner"></div><p style="color: var(--purple-600); font-size: 0.875rem; margin-top: 1rem;">This may take 10-30 seconds</p></div>';
        try {
          const qs = await generateQuiz(course, unit, false);
          showQuizModal(course, unit, qs, 5, 5, checkSpan, false, modal, quizContent);
        } catch (error) {
          console.error('Failed to load quiz:', error);
          quizContent.innerHTML = `<p style="color: #ef4444; font-weight: 600;">Error loading quiz: ${error.message}</p><p style="color: #4b5563; margin-top: 1rem;">Make sure Ollama is running (ollama serve) and llama3.2 is installed.</p>`;
        }
      };
    }

    async function openFinalExam(course, checkSpan) {
      const modal = createEl('div', 'modal-overlay');
      modal.id = 'quizModal';
      
      const content = createEl('div', 'modal-content large');
      const title = createEl('h2', '', `${course} ‚Äî Final Exam`);
      const quizContent = createEl('div');
      quizContent.id = 'quizContent';
      
      const startBtn = createEl('button', 'modal-btn', 'Start');
      startBtn.id = 'startQuiz';
      quizContent.appendChild(startBtn);
      
      const closeBtn = createEl('button', 'modal-btn secondary', 'Close');
      closeBtn.id = 'closeQuiz';
      
      content.appendChild(title);
      content.appendChild(quizContent);
      content.appendChild(closeBtn);
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      closeBtn.onclick = () => modal.remove();

      startBtn.onclick = async () => {
        quizContent.innerHTML = '<div class="loading-container"><p style="color: var(--purple-800); font-weight: 600;">Generating final exam with Ollama...</p><div class="loading-spinner"></div><p style="color: var(--purple-600); font-size: 0.875rem; margin-top: 1rem;">This may take 30-60 seconds</p></div>';
        try {
          const qs = await generateQuiz(course, 'Final Exam', true);
          showQuizModal(course, 'Final Exam', qs, 20, 18, checkSpan, true, modal, quizContent);
        } catch (error) {
          console.error('Failed to load final exam:', error);
          quizContent.innerHTML = `<p style="color: #ef4444; font-weight: 600;">Error loading final exam: ${error.message}</p><p style="color: #4b5563; margin-top: 1rem;">Make sure Ollama is running (ollama serve) and llama3.2 is installed.</p>`;
        }
      };
    }

    async function showQuizModal(course, unit, questions, totalCount, passThreshold, checkSpan, isFinal, modal, quizContent) {
      let index = 0, score = 0, earnedXP = 0;

      async function renderNext() {
        quizContent.innerHTML = '';
        if (index >= questions.length) {
          const passed = score >= passThreshold;
          const resultDiv = createEl('div');
          resultDiv.innerHTML = `<p class="result-text">${passed ? '‚úÖ Passed' : '‚ùå Try again'} ‚Äî Score: ${score}/${totalCount}</p><p class="result-text">Earned XP: ${earnedXP}</p>`;
          quizContent.appendChild(resultDiv);
          
          const user = auth.currentUser;
          if (user) {
            const ref = doc(db, 'users', user.uid);
            if (passed) {
              if (isFinal) {
                await setDoc(ref, { finalExams: { [course]: { passed, score } } }, { merge: true });
              } else {
                await setDoc(ref, { progress: { [course]: { [unit]: { passed, score } } } }, { merge: true });
              }
              checkSpan.textContent = '‚úÖ';
            }
            const snap = await getDoc(ref);
            const currentXP = snap.data().xp || 0;
            await updateDoc(ref, { xp: currentXP + earnedXP });
            xpDisplay.textContent = `${currentXP + earnedXP}`;
          }
          return;
        }
        
        const q = questions[index];
        if (!q || !q.question) {
          quizContent.innerHTML = `<p style="color: #4b5563;">Error: Invalid question data for question ${index + 1}.</p>`;
          index++;
          renderNext();
          return;
        }
        
        const card = createEl('div', 'question-card');
        const questionText = createEl('p', 'question-text', `Question ${index + 1}: ${q.question}`);
        card.appendChild(questionText);

        if (q.source) {
          const sourceText = createEl('p', 'source-text', q.source);
          card.appendChild(sourceText);
        }

        if (q.type === 'mcq' || q.type === 'source') {
          if (!q.choices || !Array.isArray(q.choices) || q.choices.length < 4) {
            quizContent.innerHTML = `<p style="color: #4b5563;">Error: Invalid choices for question ${index + 1}.</p>`;
            index++;
            renderNext();
            return;
          }
          q.choices.forEach(choice => {
            const btn = createEl('button', 'choice-btn', choice);
            btn.onclick = () => {
              if (choice === q.correct) {
                score++;
                earnedXP += 15;
              }
              index++;
              renderNext();
            };
            card.appendChild(btn);
          });
        } else if (q.type === 'open') {
          const ta = document.createElement('textarea');
          ta.placeholder = 'Type your answer here...';
          const submit = createEl('button', 'submit-btn', 'Submit');
          submit.disabled = true;
          ta.oninput = () => { submit.disabled = ta.value.trim() === ''; };
          submit.onclick = async () => {
            submit.disabled = true;
            submit.textContent = 'Grading...';
            try {
              const res = await gradeOpenResponse(course, unit, q.question, q.rubric, ta.value);
              if (res.pass) {
                score++;
                earnedXP += 50;
              }
              alert(`${res.pass ? '‚úÖ Correct' : '‚ùå Incorrect'}\n\n${res.feedback}`);
              index++;
              renderNext();
            } catch (error) {
              console.error('Failed to grade open response:', error);
              alert('Error grading response. Please try again.');
              submit.disabled = false;
              submit.textContent = 'Submit';
            }
          };
          card.appendChild(ta);
          card.appendChild(submit);
        }
        quizContent.appendChild(card);
      }
      renderNext();
    }

    function openSettings() {
      settingsModal.classList.remove('hidden');
    }

    function closeSettingsModal() {
      settingsModal.classList.add('hidden');
    }

    function openReselect() {
      reselectModal.classList.remove('hidden');
    }

    function closeReselectModal() {
      reselectModal.classList.add('hidden');
    }

    function populateReselectForm(selected = []) {
      reselectForm.innerHTML = '';
      Object.keys(apCourses).forEach(course => {
        const label = createEl('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = course;
        if (selected.includes(course)) input.checked = true;
        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${course}`));
        reselectForm.appendChild(label);
      });
    }

    let redirectTimeout = setTimeout(() => {
      if (!auth.currentUser) {
        window.location.href = 'index.html';
      }
    }, 5000);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log('No user signed in yet, waiting...');
        return;
      }

      clearTimeout(redirectTimeout);

      const ref = doc(db, 'users', user.uid);
      let snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { apCourses: [], progress: {}, finalExams: {}, xp: 0 });
        snap = await getDoc(ref);
      }
      const data = snap.data();

      courses.textContent = `Courses`;

      renderAPCoursesForUser(data.apCourses || [], data.progress || {}, data.xp || 0);

      settingsBtn.onclick = openSettings;
      closeSettings.onclick = closeSettingsModal;
      reselectBtn.onclick = openReselect;
      closeReselect.onclick = closeReselectModal;
      populateReselectForm(data.apCourses || []);
      saveReselect.onclick = async () => {
        const selected = Array.from(reselectForm.querySelectorAll('input:checked')).map(cb => cb.value);
        await setDoc(ref, { apCourses: selected }, { merge: true });
        renderAPCoursesForUser(selected, data.progress || {}, data.xp || 0);
        reselectModal.classList.add('hidden');
      };
      logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = 'index.html';
      };
    });
  </script>
</body>
</html>
