<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Grape Classroom</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="grape.png"/>

  <style>
    /* ──────────────────────────────────────
       Core styling (kept most of your design)
       ────────────────────────────────────── */
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    body { background:#5b21b6; color:#fff; font-family:'Inter',sans-serif; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:1.5rem; }
    nav { max-width:1200px; width:100%; display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; background:#5b21b6; border-bottom:1px solid #c4b5fd; }
    #courses { font-size:1.25rem; font-weight:700; color:#c4b5fd; transition:all .3s; }
    #courses:hover { color:#a78bfa; transform:scale(1.05); }
    #xp-display { display:flex; align-items:center; gap:.5rem; font-weight:600; color:#8b5cf6; }
    #xp-display::before { content:'Trophy'; font-size:1.25rem; }
    #settingsBtn { width:1.5rem; height:1.5rem; filter:invert(29%) sepia(69%) saturate(1485%) hue-rotate(235deg) brightness(90%) contrast(89%); transition:all .3s; cursor:pointer; }
    #settingsBtn:hover { filter:invert(62%) sepia(67%) saturate(1350%) hue-rotate(231deg) brightness(99%) contrast(94%); transform:rotate(90deg); }

    /* Dropdowns */
    #course-select { @apply w-full bg-violet-900 border border-violet-500 rounded-xl p-3 text-white shadow-lg; }
    #course-select:hover { @apply border-violet-400 shadow-xl translate-y-[-2px]; }

    /* Units list */
    #units-list button { @apply w-full text-left p-3 mb-2 rounded-lg border border-violet-500 bg-violet-900 text-white transition-all; }
    #units-list button:hover { @apply bg-violet-800 translate-y-[-2px] shadow-lg; }

    /* Modals – reuse Tailwind classes */
    .modal { @apply fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden; }
    .modal.show { @apply flex; }
    .modal .card { @apply bg-violet-900 rounded-xl p-6 w-full max-w-lg shadow-2xl text-white; }

    @media (max-width:640px) {
      nav { padding:.5rem; }
      #courses { font-size:1rem; }
      .modal .card { @apply w-11/12; }
    }
  </style>
</head>

<body class="flex flex-col items-center">

  <!-- ────── NAVBAR ────── -->
  <nav class="flex items-center justify-between w-full max-w-5xl">
    <div class="flex items-center gap-3">
      <img src="grape.png" alt="Logo" class="w-8 h-8 rounded-full">
      <h1 id="courses" class="font-bold">Courses</h1>
      <span id="xp-display">0</span>
    </div>
    <img id="settingsBtn" src="https://img.icons8.com/ios/512/7950F2/settings.png" alt="Settings">
  </nav>

  <!-- ────── COURSE SELECT ────── -->
  <div class="w-full max-w-5xl mt-4">
    <select id="course-select" class="w-full">
      <option value="" disabled selected>Select a Course</option>
    </select>
  </div>

  <!-- ────── UNITS LIST ────── -->
  <div id="units-list" class="w-full max-w-5xl mt-2"></div>

  <!-- ────── SETTINGS MODAL ────── -->
  <div id="settingsModal" class="modal">
    <div class="card">
      <h2 class="text-xl font-bold mb-4">Settings</h2>
      <button id="reselectBtn" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-500 mb-2">Reselect AP Courses</button>
      <button id="logoutBtn"   class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-500 mb-2">Log Out</button>
      <button id="closeSettings" class="w-full text-purple-300 underline">Cancel</button>
    </div>
  </div>

  <!-- ────── RESELECT MODAL ────── -->
  <div id="reselectModal" class="modal">
    <div class="card max-w-2xl">
      <h2 class="text-xl font-bold mb-4">Reselect AP Courses</h2>
      <form id="reselectForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto mb-4"></form>
      <button id="saveReselect" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-500 mb-2">Save</button>
      <button id="closeReselect" class="w-full bg-gray-700 text-purple-300 py-2 rounded hover:bg-gray-600">Cancel</button>
    </div>
  </div>

  <!-- ────── QUIZ MODAL (will be injected) ────── -->
  <div id="quizModal" class="modal"></div>

  <!-- ────── SCRIPTS ────── -->
  <script type="module">
    // ────────────────────── Firebase ──────────────────────
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdOUtoPjAHyXoxBJPJvAVsveMuPA2vUSQ",
      authDomain: "grape-mcps.firebaseapp.com",
      projectId: "grape-mcps",
      storageBucket: "grape-mcps.firebasestorage.app",
      messagingSenderId: "909399056268",
      appId: "1:909399056268:web:3ac13a43d1e1846649c0a9",
      measurementId: "G-X2DELV9RFD"
    };
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // ────────────────────── UI Elements ──────────────────────
    const els = {
      xp: document.getElementById('xp-display'),
      courseSel: document.getElementById('course-select'),
      unitsList: document.getElementById('units-list'),
      settingsBtn: document.getElementById('settingsBtn'),
      settingsModal: document.getElementById('settingsModal'),
      reselectModal: document.getElementById('reselectModal'),
      reselectForm: document.getElementById('reselectForm'),
      saveReselect: document.getElementById('saveReselect'),
      closeReselect: document.getElementById('closeReselect'),
      closeSettings: document.getElementById('closeSettings'),
      logoutBtn: document.getElementById('logoutBtn'),
      reselectBtn: document.getElementById('reselectBtn')
    };

    // ────────────────────── AP Course Data ──────────────────────
    const apCourses = {
      "AP African American Studies": ["Unit 1: Introduction to African American Studies"],
      "AP Art & Design: 2D": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art & Design: 3D": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art & Design: Drawing": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art History": [
        "Unit 1: Global Prehistoric Art, 30,000-500 BCE",
        "Unit 2: Ancient Mediterranean Art, 3500-300 BCE",
        "Unit 3: Early European and Colonial American Art, 200-1750 CE",
        "Unit 4: Later European and American Art, 1750-1980 CE",
        "Unit 5: Indigenous American Art, 1000 BCE-1980 CE",
        "Unit 6: African Art, 1100-1980 CE",
        "Unit 7: West and Central Asian Art, 500 BCE-1980 CE",
        "Unit 8: South, East, and Southeast Asian Art, 300 BCE-1980 CE",
        "Unit 9: Art in the Pacific, 700-1980 CE",
        "Unit 10: Global Contemporary Art, 1980 CE to Present"
      ],
      "AP Biology": [
        "Unit 1: Chemistry of Life",
        "Unit 2: Cell Structure and Function",
        "Unit 3: Cellular Energetics",
        "Unit 4: Cell Communication and Cell Cycle",
        "Unit 5: Heredity",
        "Unit 6: Gene Expression and Regulation",
        "Unit 7: Natural Selection",
        "Unit 8: Ecology"
      ],
      "AP Calculus AB": [
        "Unit 1: Limits and Continuity",
        "Unit 2: Differentiation - Definition and Fundamental Properties",
        "Unit 3: Differentiation - Composite, Implicit, and Inverse Functions",
        "Unit 4: Contextual Applications of Differentiation",
        "Unit 5: Analytical Applications of Differentiation",
        "Unit 6: Integration and Accumulation of Change",
        "Unit 7: Differential Equations",
        "Unit 8: Applications of Integration"
      ],
      "AP Calculus BC": [
        "Unit 1: Limits and Continuity",
        "Unit 2: Differentiation - Definition and Fundamental Properties",
        "Unit 3: Differentiation - Composite, Implicit, and Inverse Functions",
        "Unit 4: Contextual Applications of Differentiation",
        "Unit 5: Analytical Applications of Differentiation",
        "Unit 6: Integration and Accumulation of Change",
        "Unit 7: Differential Equations",
        "Unit 8: Applications of Integration",
        "Unit 9: Parametric Equations, Polar Coordinates, and Vector-Valued Functions",
        "Unit 10: Infinite Sequences and Series"
      ],
      "AP Chemistry": [
        "Unit 1: Atomic Structure and Properties",
        "Unit 2: Molecular and Ionic Bonding",
        "Unit 3: Intermolecular Forces and Properties",
        "Unit 4: Chemical Reactions",
        "Unit 5: Kinetics",
        "Unit 6: Thermodynamics",
        "Unit 7: Equilibrium",
        "Unit 8: Acids and Bases",
        "Unit 9: Applications of Thermodynamics"
      ],
      "AP Chinese": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Comparative Government": [
        "Unit 1: Political Systems, Regimes, and Governments",
        "Unit 2: Political Institutions",
        "Unit 3: Political Culture and Participation",
        "Unit 4: Party, Electoral Systems, and Citizen Organizations",
        "Unit 5: Political and Economic Changes and Development"
      ],
      "AP Computer Science A": [
        "Unit 1: Primitive Types",
        "Unit 2: Using Objects",
        "Unit 3: Boolean Expressions and If Statements",
        "Unit 4: Iteration",
        "Unit 5: Writing Classes",
        "Unit 6: Arrays",
        "Unit 7: ArrayLists",
        "Unit 8: 2D Arrays",
        "Unit 9: Inheritance",
        "Unit 10: Recursion"
      ],
      "AP Computer Science Principles": [
        "Unit 1: Creative Development",
        "Unit 2: Data",
        "Unit 3: Algorithms and Programming",
        "Unit 4: Computer Systems and Networks",
        "Unit 5: Impact of Computing"
      ],
      "AP English Language": [
        "Unit 1: Claims, Reasoning, and Evidence",
        "Unit 2: Organizing Information for a Specific Audience",
        "Unit 3: Perspectives and How Arguments Relate",
        "Unit 4: How Writers Develop Arguments, Intros, and Conclusions",
        "Unit 5: How a Writer Brings All Parts of an Argument Together",
        "Unit 6: Position, Perspective, and Bias",
        "Unit 7: Successful and Unsuccessful Arguments",
        "Unit 8: Stylistic Choices",
        "Unit 9: Developing a Complex Argument"
      ],
      "AP English Literature": [
        "Unit 1: Short Fiction I: Introduction to Short Fiction",
        "Unit 2: Poetry I: Introduction to Poetry",
        "Unit 3: Longer Fiction and Drama I: Introduction to Longer Fiction and Drama",
        "Unit 4: Short Fiction II: Character, Conflict, and Storytelling",
        "Unit 5: Poetry II: Structure and Figurative Language",
        "Unit 6: Longer Fiction or Drama II: Literary Techniques in Longer Works",
        "Unit 7: Short Fiction III: Societal and Historical Context",
        "Unit 8: Poetry III: Contrast, Ambiguous Language, and Other Techniques",
        "Unit 9: Longer Fiction or Drama III: Nuanced Analysis"
      ],
      "AP Environmental Science": [
        "Unit 1: The Living World: Ecosystems",
        "Unit 2: The Living World: Biodiversity",
        "Unit 3: Populations",
        "Unit 4: Earth Systems and Resources",
        "Unit 5: Land and Water Use",
        "Unit 6: Energy Resources and Consumption",
        "Unit 7: Atmospheric Pollution",
        "Unit 8: Aquatic and Terrestrial Pollution",
        "Unit 9: Global Change"
      ],
      "AP European History": [
        "Unit 1: Renaissance and Exploration",
        "Unit 2: Age of Reformation",
        "Unit 3: Absolutism and Constitutionalism",
        "Unit 4: Scientific, Philosophical, and Political Developments",
        "Unit 5: Conflict, Crisis, and Reaction in the Late 18th Century",
        "Unit 6: Industrialization and Its Effects",
        "Unit 7: 19th Century Perspectives and Political Developments",
        "Unit 8: 20th Century Global Conflicts",
        "Unit 9: Cold War and Contemporary Europe"
      ],
      "AP French": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP German": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Human Geography": [
        "Unit 1: Thinking Geographically",
        "Unit 2: Population and Migration Patterns and Processes",
        "Unit 3: Cultural Patterns and Processes",
        "Unit 4: Political Patterns and Processes",
        "Unit 5: Agriculture and Rural Land-Use Patterns and Processes",
        "Unit 6: Cities and Urban Land-Use",
        "Unit 7: Industrial and Economic Development Patterns and Processes"
      ],
      "AP Italian": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Japanese": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Latin": [
        "Unit 1: Vergil, Aeneid, Book 1",
        "Unit 2: Vergil, Aeneid, Book 2",
        "Unit 3: Vergil, Aeneid, Book 4",
        "Unit 4: Vergil, Aeneid, Book 6",
        "Unit 5: Catullus, Selected Poems",
        "Unit 6: Caesar, Selected Passages",
        "Unit 7: Cicero, Selected Speeches"
      ],
      "AP Macroeconomics": [
        "Unit 1: Basic Economic Concepts",
        "Unit 2: Economic Indicators and the Business Cycle",
        "Unit 3: National Income and Price Determination",
        "Unit 4: Financial Sector",
        "Unit 5: Long-Run Consequences of Stabilization Policies",
        "Unit 6: Open Economy - International Trade and Finance"
      ],
      "AP Microeconomics": [
        "Unit 1: Basic Economic Concepts",
        "Unit 2: Supply and Demand",
        "Unit 3: Production, Cost, and the Perfect Competition Model",
        "Unit 4: Imperfect Competition",
        "Unit 5: Factor Markets",
        "Unit 6: Market Failure and the Role of Government"
      ],
      "AP Music Theory": [
        "Unit 1: Music Fundamentals I",
        "Unit 2: Music Fundamentals II",
        "Unit 3: Music Fundamentals III",
        "Unit 4: Harmony and Voice Leading I",
        "Unit 5: Harmony and Voice Leading II",
        "Unit 6: Harmony and Voice Leading III",
        "Unit 7: Harmony and Voice Leading IV",
        "Unit 8: Modes and Form"
      ],
      "AP Physics 1": [
        "Unit 1: Kinematics",
        "Unit 2: Dynamics",
        "Unit 3: Circular Motion and Gravitation",
        "Unit 4: Energy",
        "Unit 5: Momentum",
        "Unit 6: Simple Harmonic Motion",
        "Unit 7: Torque and Rotational Motion"
      ],
      "AP Physics 2": [
        "Unit 1: Fluids",
        "Unit 2: Thermodynamics",
        "Unit 3: Electric Force, Field, and Potential",
        "Unit 4: Electric Circuits",
        "Unit 5: Magnetism and Electromagnetic Induction",
        "Unit 6: Geometric and Physical Optics",
        "Unit 7: Quantum, Atomic, and Nuclear Physics"
      ],
      "AP Physics C: Electricity & Magnetism": [
        "Unit 1: Electrostatics",
        "Unit 2: Conductors, Capacitors, Dielectrics",
        "Unit 3: Electric Circuits",
        "Unit 4: Magnetic Fields",
        "Unit 5: Electromagnetism"
      ],
      "AP Physics C: Mechanics": [
        "Unit 1: Kinematics",
        "Unit 2: Newton’s Laws of Motion",
        "Unit 3: Work, Energy, and Power",
        "Unit 4: Systems of Particles and Linear Momentum",
        "Unit 5: Rotation",
        "Unit 6: Oscillations",
        "Unit 7: Gravitation"
      ],
      "AP Pre-Calculus": [
        "Unit 1: Polynomial and Rational Functions",
        "Unit 2: Exponential and Logarithmic Functions",
        "Unit 3: Trigonometric and Polar Functions",
        "Unit 4: Functions Involving Parameters, Vectors, and Matrices"
      ],
      "AP Psychology": [
        "Unit 1: Scientific Foundations of Psychology",
        "Unit 2: Biological Basis of Behavior",
        "Unit 3: Sensation and Perception",
        "Unit 4: Learning",
        "Unit 5: Cognitive Psychology",
        "Unit 6: Developmental Psychology",
        "Unit 7: Motivation, Emotion, and Personality",
        "Unit 8: Clinical Psychology",
        "Unit 9: Social Psychology"
      ],
      "AP Research": [
        "Unit 1: Question and Explore",
        "Unit 2: Understand and Analyze",
        "Unit 3: Evaluate Multiple Perspectives",
        "Unit 4: Synthesize Ideas",
        "Unit 5: Team, Transform, and Transmit"
      ],
      "AP Seminar": [
        "Unit 1: Question and Explore",
        "Unit 2: Understand and Analyze",
        "Unit 3: Evaluate Multiple Perspectives",
        "Unit 4: Synthesize Ideas",
        "Unit 5: Team, Transform, and Transmit"
      ],
      "AP Spanish Language": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Spanish Literature": [
        "Unit 1: La época medieval",
        "Unit 2: El siglo XVI",
        "Unit 3: El siglo XVII",
        "Unit 4: La literatura romántica, realista y naturalista",
        "Unit 5: La Generación del 98 y el Modernismo",
        "Unit 6: Teatro y poesía del siglo XX",
        "Unit 7: El Boom latinoamericano",
        "Unit 8: Escritores contemporáneos de Estados Unidos, y España"
      ],
      "AP Statistics": [
        "Unit 1: Exploring One-Variable Data",
        "Unit 2: Exploring Two-Variable Data",
        "Unit 3: Collecting Data",
        "Unit 4: Probability, Random Variables, and Probability Distributions",
        "Unit 5: Sampling Distributions",
        "Unit 6: Inference for Categorical Data - Proportions",
        "Unit 7: Inference for Quantitative Data - Means",
        "Unit 8: Inference for Categorical Data - Chi-Squares",
        "Unit 9: Inference for Quantitative Data - Slopes"
      ],
      "AP US Government": [
        "Unit 1: Foundations of American Democracy",
        "Unit 2: Interactions Among Branches of Government",
        "Unit 3: Civil Liberties and Civil Rights",
        "Unit 4: American Political Ideologies and Beliefs",
        "Unit 5: Political Participation"
      ],
      "AP US History": [
        "Unit 1: 1491-1607 (Columbus to Jamestown)",
        "Unit 2: 1607-1754 (Colonial Society)",
        "Unit 3: 1754-1800 (American Revolution and Constitution)",
        "Unit 4: 1800-1848 (American Expansion)",
        "Unit 5: 1844-1877 (Civil War and Reconstruction)",
        "Unit 6: 1865-1898 (Gilded Age)",
        "Unit 7: 1898-1945 (Global Conflict)",
        "Unit 8: 1945-1980 (Cold War and Protest)",
        "Unit 9: 1980 to Present (Post-Cold War Shifts)"
      ],
      "AP World History: Modern": [
        "Unit 1: The Global Tapestry",
        "Unit 2: Networks of Exchange",
        "Unit 3: Land-Based Empires",
        "Unit 4: Transoceanic Interactions",
        "Unit 5: Revolutions",
        "Unit 6: Consequences of Industrialization",
        "Unit 7: Global Conflict",
        "Unit 8: Cold War and Decolonization",
        "Unit 9: Globalization"
      ]
    };

    // ────────────────────── Gemini Helper ──────────────────────
    const GEMINI_API_KEY = "AIzaSyDNAAETxjKgPNYtH4kMu5rz0gvXad7UVwU"; // <-- MOVE TO SERVER-SIDE IN PRODUCTION
    const GEMINI_MODEL   = "gemini-1.5-flash";
    const GEMINI_URL     = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

    async function geminiJSON(prompt, schema) {
      const body = {
        contents: [{ role: "user", parts: [{ text: prompt }]}],
        generationConfig: { response_mime_type: "application/json", response_schema: schema }
      };
      const res = await fetch(GEMINI_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body) });
      if (!res.ok) throw new Error(`Gemini ${res.status}`);
      const data = await res.json();
      return JSON.parse(data.candidates[0].content.parts[0].text);
    }

    // ────────────────────── Quiz Generation ──────────────────────
    async function generateQuiz(course, unit, isFinal = false) {
      const count = isFinal ? 20 : 5;
      const prompt = `
You are generating AP-style questions for ${course}, topic: ${unit}.
${isFinal ? "Make 20 questions (16 MCQ, at least 2 source-analysis, 4 open-response)." 
           : "Make 5 questions (3 MCQ, 1 source-analysis, 1 open-response)."}
For MCQs: include 4 choices, 'correct', and 'explanation'.
For source-analysis: include 'source' text, 4 choices, 'correct', 'explanation'.
For open-response: include 'rubric'.
Type is 'mcq' for standard MCQ, 'source' for source-analysis, 'open' for open-response.
Output JSON only.`;

      const schema = {
        type: "object",
        properties: {
          questions: {
            type: "array",
            items: {
              type: "object",
              properties: {
                type: { type: "string" },
                question: { type: "string" },
                source: { type: "string" },
                choices: { type: "array", items: { type: "string" } },
                correct: { type: "string" },
                explanation: { type: "string" },
                rubric: { type: "string" }
              }
            }
          }
        }
      };
      return (await geminiJSON(prompt, schema)).questions;
    }

    // ────────────────────── UI Helpers ──────────────────────
    const $ = (tag, cls, txt) => { const e = document.createElement(tag); if(cls) e.className=cls; if(txt) e.textContent=txt; return e; };
    const closeModal = m => { m.classList.remove('show'); m.classList.add('hidden'); };
    const openModal  = m => { m.classList.remove('hidden'); m.classList.add('show'); };

    // ────────────────────── Render Logic ──────────────────────
    function renderCourses(selected = [], progress = {}, xp = 0) {
      els.xp.textContent = xp;
      els.courseSel.innerHTML = '<option value="" disabled selected>Select a Course</option>';
      els.unitsList.innerHTML = '';

      if (!selected.length) {
        els.unitsList.textContent = "No courses selected – open Settings.";
        return;
      }

      selected.forEach(c => els.courseSel.appendChild($('option','',c)).value = c);
      els.courseSel.value = selected[0];
      renderUnits(selected[0], progress);
    }

    function renderUnits(course, progress = {}) {
      els.unitsList.innerHTML = '';
      const units = apCourses[course] || [];
      units.forEach(u => {
        const btn = $('button','',u);
        const chk = $('span','ml-2 text-green-400');
        if (progress[course]?.[u]?.passed) chk.textContent='Checkmark';
        btn.appendChild(chk);
        btn.onclick = () => startUnitQuiz(course, u, chk);
        els.unitsList.appendChild(btn);
      });

      // Final exam button
      const finalBtn = $('button','text-white','Final Exam');
      const fchk = $('span','ml-2 text-green-400');
      if (progress.finalExams?.[course]?.passed) fchk.textContent='Checkmark';
      finalBtn.appendChild(fchk);
      finalBtn.onclick = () => startFinalExam(course, fchk);
      els.unitsList.appendChild(finalBtn);
    }

    // ────────────────────── Quiz Flow ──────────────────────
    async function startUnitQuiz(course, unit, chk) {
      const qs = await generateQuiz(course, unit, false);
      openQuizModal(course, unit, qs, 5, 5, chk, false);
    }
    async function startFinalExam(course, chk) {
      const qs = await generateQuiz(course, 'Final Exam', true);
      openQuizModal(course, 'Final Exam', qs, 20, 18, chk, true);
    }

    function openQuizModal(course, unit, questions, total, pass, chk, isFinal) {
      const modal = document.getElementById('quizModal');
      modal.innerHTML = `
        <div class="card max-w-2xl">
          <h2 class="font-bold text-xl mb-4">${course} — ${unit}</h2>
          <div id="quizContent"></div>
          <button id="closeQuiz" class="mt-4 w-full bg-gray-700 text-purple-300 py-2 rounded hover:bg-gray-600">Close</button>
        </div>`;
      openModal(modal);
      const content = modal.querySelector('#quizContent');
      modal.querySelector('#closeQuiz').onclick = () => closeModal(modal);

      let idx=0, score=0, xpEarned=0;
      const next = async () => {
        if (idx >= questions.length) {
          const passed = score >= pass;
          content.innerHTML = `<p class="text-white">${passed?'Passed':'Failed'} – ${score}/${total}</p>
                               <p class="text-white">XP +${xpEarned}</p>`;
          if (auth.currentUser) {
            const ref = doc(db,'users',auth.currentUser.uid);
            if (passed) {
              const path = isFinal ? {finalExams:{[course]:{passed,score}}} : {progress:{[course]:{[unit]:{passed,score}}}};
              await setDoc(ref, path, {merge:true});
              chk.textContent='Checkmark';
            }
            const snap = await getDoc(ref);
            const curXP = snap.data()?.xp||0;
            await updateDoc(ref, {xp: curXP + xpEarned});
            els.xp.textContent = curXP + xpEarned;
          }
          return;
        }
        const q = questions[idx];
        const card = $('div','border p-3 rounded mb-3');
        card.appendChild($('p','font-semibold text-white',q.question));
        if (q.source) card.appendChild($('p','italic mb-2 text-white',q.source));

        if (q.type==='mcq' || q.type==='source') {
          q.choices.forEach(ch => {
            const btn = $('button','block border rounded p-2 w-full mb-1 text-white',ch);
            btn.onclick = () => { if(ch===q.correct){score++; xpEarned+=15;} idx++; next(); };
            card.appendChild(btn);
          });
        } else if (q.type==='open') {
          const ta = document.createElement('textarea');
          ta.className='w-full border p-2 mb-2';
          const sub = $('button','bg-purple-600 text-white px-3 py-1 rounded','Submit');
          sub.disabled=true;
          ta.oninput = ()=>{ sub.disabled=!ta.value.trim(); };
          sub.onclick = async () => {
            const {pass,feedback} = await gradeOpenResponse(course, unit, q.question, q.rubric, ta.value);
            if(pass){score++; xpEarned+=50;}
            idx++; next();
          };
          card.appendChild(ta); card.appendChild(sub);
        }
        content.appendChild(card);
      };
      next();
    }

    async function gradeOpenResponse(course, unit, question, rubric, answer) {
      const prompt = `Course: ${course}\nUnit: ${unit}\nQuestion: ${question}\nRubric: ${rubric}\nStudent answer:\n${answer}\nReturn JSON {pass:boolean, feedback:string}.`;
      const schema = {type:"object",properties:{pass:{type:"boolean"},feedback:{type:"string"}}};
      return await geminiJSON(prompt, schema);
    }

    // ────────────────────── Settings / Reselect ──────────────────────
    els.settingsBtn.onclick = () => openModal(els.settingsModal);
    els.closeSettings.onclick = () => closeModal(els.settingsModal);
    els.reselectBtn.onclick = () => {
      populateReselectForm(userData?.apCourses||[]);
      openModal(els.reselectModal);
    };
    els.closeReselect.onclick = () => closeModal(els.reselectModal);
    els.saveReselect.onclick = async () => {
      const selected = [...els.reselectForm.querySelectorAll('input:checked')].map(i=>i.value);
      await setDoc(doc(db,'users',auth.currentUser.uid), {apCourses:selected}, {merge:true});
      renderCourses(selected, userData?.progress||{}, userData?.xp||0);
      closeModal(els.reselectModal);
    };
    els.logoutBtn.onclick = async () => { await signOut(auth); location.href='index.html'; };

    function populateReselectForm(selected=[]) {
      els.reselectForm.innerHTML='';
      Object.keys(apCourses).forEach(c=>{
        const lbl = $('label','flex items-center gap-2 p-2 rounded hover:bg-violet-800 cursor-pointer');
        const cb  = document.createElement('input');
        cb.type='checkbox'; cb.value=c; if(selected.includes(c)) cb.checked=true;
        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(c));
        els.reselectForm.appendChild(lbl);
      });
    }

    // ────────────────────── Auth Listener ──────────────────────
    let userData = null;
    onAuthStateChanged(auth, async user => {
      if (!user) { setTimeout(() => location.href='index.html', 3000); return; }
      const ref = doc(db,'users',user.uid);
      let snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, {apCourses:[],progress:{},finalExams:{},xp:0});
      snap = await getDoc(ref);
      userData = snap.data();
      renderCourses(userData.apCourses, userData.progress, userData.xp);
    });

  </script>
</body>
</html>
