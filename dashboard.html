<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Grape Classroom</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="grape.png" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #5b21b6;
      font-family: 'Inter', sans-serif;
      color: #ffffff;
      transition: background-color 0.3s ease;
    }

    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 1200px;
      padding: 0.75rem 1rem;
      background: #5b21b6;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #c4b5fd;
      transition: transform 0.3s ease;
    }

    nav:hover {
      transform: translateY(-1px);
    }

    #courses {
      font-size: 1.25rem;
      font-weight: 700;
      color: #c4b5fd;
      transition: color 0.3s ease, transform 0.3s ease;
    }

    #courses:hover {
      color: #a78bfa;
      transform: scale(1.05);
    }

    #xp-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #8b5cf6;
      background: none;
      padding: 0.25rem 0.5rem;
      transition: transform 0.3s ease, color 0.3s ease;
    }

    #xp-display::before {
      content: 'üéñÔ∏è';
      font-size: 1.25rem;
      color: #c4b5fd;
      transition: transform 0.3s ease, color 0.3s ease;
    }

    #xp-display:hover {
      color: #a78bfa;
      transform: scale(1.05);
    }

    #xp-display:hover::before {
      color: #a78bfa;
      transform: rotate(15deg);
    }

    #settingsBtn {
      width: 1.5rem;
      height: 1.5rem;
      opacity: 0.7;
      filter: invert(29%) sepia(69%) saturate(1485%) hue-rotate(235deg) brightness(90%) contrast(89%);
      transition: transform 0.3s ease, opacity 0.3s ease, filter 0.3s ease;
    }

    #settingsBtn:hover {
      filter: invert(62%) sepia(67%) saturate(1350%) hue-rotate(231deg) brightness(99%) contrast(94%);
      transform: rotate(90deg);
      opacity: 1;
    }

    #course-select-container {
      width: 100%;
      max-width: 1200px;
      margin-top: 1rem;
    }

    #course-select {
      width: 100%;
      background: #5b21b6;
      border: 1px solid #a78bfa;
      border-radius: 0.75rem;
      padding: 0.75rem;
      font-size: 1rem;
      color: #ffffff;
      box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg fill='%23a78bfa' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1.5rem;
    }

    #course-select:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px -2px rgba(139, 92, 246, 0.3);
      border-color: #8b5cf6;
    }

    #course-select:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px #c4b5fd;
    }

    #course-select option {
      padding: 0.5rem;
      color: #ffffff;
      background: #5b21b6;
    }

    #units-list {
      width: 100%;
      max-width: 1200px;
      margin-top: 0.5rem;
    }

    #units-list button {
      display: block;
      width: 100%;
      background: #5b21b6;
      border: 1px solid #a78bfa;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      text-align: left;
      color: #ffffff;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }

    #units-list button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px -2px rgba(139, 92, 246, 0.3);
      background: #6d28d9;
    }

    #settingsModal, #reselectModal, #quizModal {
      animation: none;
    }

    #settingsModal .bg-white, #reselectModal .bg-white, #quizModal .bg-white {
      background: #5b21b6;
      border: 1px solid #a78bfa;
      box-shadow: 0 10px 20px rgba(139, 92, 246, 0.15);
      border-radius: 1rem;
      color: #ffffff;
      transition: transform 0.3s ease;
    }

    #settingsModal.show, #reselectModal.show, #quizModal.show {
      display: flex !important;
    }

    button {
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    }

    #reselectBtn, #saveReselect, #startQuiz {
      background: #8b5cf6;
      color: #ffffff;
    }

    #reselectBtn:hover, #saveReselect:hover, #startQuiz:hover {
      background: #a78bfa;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
    }

    #logoutBtn {
      background: #ef4444;
      color: #ffffff;
    }

    #logoutBtn:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }

    #closeSettings, #closeReselect, #closeQuiz {
      color: #c4b5fd;
      transition: color 0.3s ease;
    }

    #closeSettings:hover, #closeReselect:hover, #closeQuiz:hover {
      color: #a78bfa;
      text-decoration: none;
    }

    #reselectForm label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      color: #ffffff;
      transition: background-color 0.3s ease;
    }

    #reselectForm label:hover {
      background: #6d28d9;
    }

    #reselectForm input[type="checkbox"] {
      accent-color: #8b5cf6;
      width: 1.25rem;
      height: 1.25rem;
      transition: transform 0.2s ease;
    }

    #reselectForm input[type="checkbox"]:hover {
      transform: scale(1.1);
    }

    #quizModal textarea {
      background: #5b21b6;
      border: 1px solid #a78bfa;
      color: #ffffff;
    }

    #quizModal .border {
      border-color: #a78bfa;
    }

    @media (max-width: 640px) {
      nav {
        padding: 0.5rem;
      }

      #courses {
        font-size: 1rem;
      }

      #xp-display {
        font-size: 0.85rem;
      }

      #settingsBtn {
        width: 1.25rem;
        height: 1.25rem;
      }

      #settingsModal .bg-white, #reselectModal .bg-white, #quizModal .bg-white {
        width: 90%;
      }

      #course-select, #units-list button {
        font-size: 0.9rem;
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">
  <div class="w-full flex items-center justify-center">
    <nav class="flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <img src="grape.png" alt="Grape Logo" class="w-8 h-8 rounded-full">
        <h1 id="courses" class="font-bold">Courses</h1>
        <span id="xp-display">0</span>
      </div>
      <div>
        <img id="settingsBtn" src="https://img.icons8.com/ios11/512/7950F2/settings.png" alt="Settings" class="cursor-pointer">
      </div>
    </nav>
  </div>

  <div id="course-select-container" class="w-full max-w-5xl">
    <select id="course-select" name="course" class="w-full">
      <option value="" disabled>Select a Course</option>
    </select>
  </div>

  <div id="units-list" class="w-full max-w-5xl"></div>

  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex justify-center items-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-xl">
      <h2 class="text-xl font-bold text-white mb-4">Settings</h2>
      <button id="reselectBtn" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-500 mb-3">Reselect AP Courses</button>
      <button id="logoutBtn" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600">Log Out</button>
      <button id="closeSettings" class="mt-3 text-purple-300 underline">Cancel</button>
    </div>
  </div>

  <div id="reselectModal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex justify-center items-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl shadow-xl">
      <h2 class="text-xl font-bold text-white mb-4">Reselect AP Courses</h2>
      <form id="reselectForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-96 overflow-y-auto mb-4"></form>
      <button id="saveReselect" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-500 mb-2">Save</button>
      <button id="closeReselect" class="w-full bg-gray-200 text-purple-300 py-2 rounded hover:bg-gray-300">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      setPersistence, 
      browserLocalPersistence, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdOUtoPjAHyXoxBJPJvAVsveMuPA2vUSQ",
      authDomain: "grape-mcps.firebaseapp.com",
      projectId: "grape-mcps",
      storageBucket: "grape-mcps.firebasestorage.app",
      messagingSenderId: "909399056268",
      appId: "1:909399056268:web:3ac13a43d1e1846649c0a9",
      measurementId: "G-X2DELV9RFD"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    await setPersistence(auth, browserLocalPersistence);

    const courses = document.getElementById("courses");
    const xpDisplay = document.getElementById("xp-display");
    const courseSelect = document.getElementById("course-select");
    const unitsList = document.getElementById("units-list");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsModal = document.getElementById("settingsModal");
    const closeSettings = document.getElementById("closeSettings");
    const logoutBtn = document.getElementById("logoutBtn");
    const reselectBtn = document.getElementById("reselectBtn");
    const reselectModal = document.getElementById("reselectModal");
    const reselectForm = document.getElementById("reselectForm");
    const saveReselect = document.getElementById("saveReselect");
    const closeReselect = document.getElementById("closeReselect");

    const apCourses = {
      "AP African American Studies": ["Unit 1: Introduction to African American Studies"],
      "AP Art & Design: 2D": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art & Design: 3D": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art & Design: Drawing": ["Unit 1: Explore Materials, Processes, and Ideas", "Unit 2: Make Art and Design", "Unit 3: Present Art and Design"],
      "AP Art History": [
        "Unit 1: Global Prehistoric Art, 30,000-500 BCE",
        "Unit 2: Ancient Mediterranean Art, 3500-300 BCE",
        "Unit 3: Early European and Colonial American Art, 200-1750 CE",
        "Unit 4: Later European and American Art, 1750-1980 CE",
        "Unit 5: Indigenous American Art, 1000 BCE-1980 CE",
        "Unit 6: African Art, 1100-1980 CE",
        "Unit 7: West and Central Asian Art, 500 BCE-1980 CE",
        "Unit 8: South, East, and Southeast Asian Art, 300 BCE-1980 CE",
        "Unit 9: Art in the Pacific, 700-1980 CE",
        "Unit 10: Global Contemporary Art, 1980 CE to Present"
      ],
      "AP Biology": [
        "Unit 1: Chemistry of Life",
        "Unit 2: Cell Structure and Function",
        "Unit 3: Cellular Energetics",
        "Unit 4: Cell Communication and Cell Cycle",
        "Unit 5: Heredity",
        "Unit 6: Gene Expression and Regulation",
        "Unit 7: Natural Selection",
        "Unit 8: Ecology"
      ],
      "AP Calculus AB": [
        "Unit 1: Limits and Continuity",
        "Unit 2: Differentiation - Definition and Fundamental Properties",
        "Unit 3: Differentiation - Composite, Implicit, and Inverse Functions",
        "Unit 4: Contextual Applications of Differentiation",
        "Unit 5: Analytical Applications of Differentiation",
        "Unit 6: Integration and Accumulation of Change",
        "Unit 7: Differential Equations",
        "Unit 8: Applications of Integration"
      ],
      "AP Calculus BC": [
        "Unit 1: Limits and Continuity",
        "Unit 2: Differentiation - Definition and Fundamental Properties",
        "Unit 3: Differentiation - Composite, Implicit, and Inverse Functions",
        "Unit 4: Contextual Applications of Differentiation",
        "Unit 5: Analytical Applications of Differentiation",
        "Unit 6: Integration and Accumulation of Change",
        "Unit 7: Differential Equations",
        "Unit 8: Applications of Integration",
        "Unit 9: Parametric Equations, Polar Coordinates, and Vector-Valued Functions",
        "Unit 10: Infinite Sequences and Series"
      ],
      "AP Chemistry": [
        "Unit 1: Atomic Structure and Properties",
        "Unit 2: Molecular and Ionic Bonding",
        "Unit 3: Intermolecular Forces and Properties",
        "Unit 4: Chemical Reactions",
        "Unit 5: Kinetics",
        "Unit 6: Thermodynamics",
        "Unit 7: Equilibrium",
        "Unit 8: Acids and Bases",
        "Unit 9: Applications of Thermodynamics"
      ],
      "AP Chinese": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Comparative Government": [
        "Unit 1: Political Systems, Regimes, and Governments",
        "Unit 2: Political Institutions",
        "Unit 3: Political Culture and Participation",
        "Unit 4: Party, Electoral Systems, and Citizen Organizations",
        "Unit 5: Political and Economic Changes and Development"
      ],
      "AP Computer Science A": [
        "Unit 1: Primitive Types",
        "Unit 2: Using Objects",
        "Unit 3: Boolean Expressions and If Statements",
        "Unit 4: Iteration",
        "Unit 5: Writing Classes",
        "Unit 6: Arrays",
        "Unit 7: ArrayLists",
        "Unit 8: 2D Arrays",
        "Unit 9: Inheritance",
        "Unit 10: Recursion"
      ],
      "AP Computer Science Principles": [
        "Unit 1: Creative Development",
        "Unit 2: Data",
        "Unit 3: Algorithms and Programming",
        "Unit 4: Computer Systems and Networks",
        "Unit 5: Impact of Computing"
      ],
      "AP English Language": [
        "Unit 1: Claims, Reasoning, and Evidence",
        "Unit 2: Organizing Information for a Specific Audience",
        "Unit 3: Perspectives and How Arguments Relate",
        "Unit 4: How Writers Develop Arguments, Intros, and Conclusions",
        "Unit 5: How a Writer Brings All Parts of an Argument Together",
        "Unit 6: Position, Perspective, and Bias",
        "Unit 7: Successful and Unsuccessful Arguments",
        "Unit 8: Stylistic Choices",
        "Unit 9: Developing a Complex Argument"
      ],
      "AP English Literature": [
        "Unit 1: Short Fiction I: Introduction to Short Fiction",
        "Unit 2: Poetry I: Introduction to Poetry",
        "Unit 3: Longer Fiction and Drama I: Introduction to Longer Fiction and Drama",
        "Unit 4: Short Fiction II: Character, Conflict, and Storytelling",
        "Unit 5: Poetry II: Structure and Figurative Language",
        "Unit 6: Longer Fiction or Drama II: Literary Techniques in Longer Works",
        "Unit 7: Short Fiction III: Societal and Historical Context",
        "Unit 8: Poetry III: Contrast, Ambiguous Language, and Other Techniques",
        "Unit 9: Longer Fiction or Drama III: Nuanced Analysis"
      ],
      "AP Environmental Science": [
        "Unit 1: The Living World: Ecosystems",
        "Unit 2: The Living World: Biodiversity",
        "Unit 3: Populations",
        "Unit 4: Earth Systems and Resources",
        "Unit 5: Land and Water Use",
        "Unit 6: Energy Resources and Consumption",
        "Unit 7: Atmospheric Pollution",
        "Unit 8: Aquatic and Terrestrial Pollution",
        "Unit 9: Global Change"
      ],
      "AP European History": [
        "Unit 1: Renaissance and Exploration",
        "Unit 2: Age of Reformation",
        "Unit 3: Absolutism and Constitutionalism",
        "Unit 4: Scientific, Philosophical, and Political Developments",
        "Unit 5: Conflict, Crisis, and Reaction in the Late 18th Century",
        "Unit 6: Industrialization and Its Effects",
        "Unit 7: 19th Century Perspectives and Political Developments",
        "Unit 8: 20th Century Global Conflicts",
        "Unit 9: Cold War and Contemporary Europe"
      ],
      "AP French": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP German": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Human Geography": [
        "Unit 1: Thinking Geographically",
        "Unit 2: Population and Migration Patterns and Processes",
        "Unit 3: Cultural Patterns and Processes",
        "Unit 4: Political Patterns and Processes",
        "Unit 5: Agriculture and Rural Land-Use Patterns and Processes",
        "Unit 6: Cities and Urban Land-Use",
        "Unit 7: Industrial and Economic Development Patterns and Processes"
      ],
      "AP Italian": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Japanese": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Latin": [
        "Unit 1: Vergil, Aeneid, Book 1",
        "Unit 2: Vergil, Aeneid, Book 2",
        "Unit 3: Vergil, Aeneid, Book 4",
        "Unit 4: Vergil, Aeneid, Book 6",
        "Unit 5: Catullus, Selected Poems",
        "Unit 6: Caesar, Selected Passages",
        "Unit 7: Cicero, Selected Speeches"
      ],
      "AP Macroeconomics": [
        "Unit 1: Basic Economic Concepts",
        "Unit 2: Economic Indicators and the Business Cycle",
        "Unit 3: National Income and Price Determination",
        "Unit 4: Financial Sector",
        "Unit 5: Long-Run Consequences of Stabilization Policies",
        "Unit 6: Open Economy - International Trade and Finance"
      ],
      "AP Microeconomics": [
        "Unit 1: Basic Economic Concepts",
        "Unit 2: Supply and Demand",
        "Unit 3: Production, Cost, and the Perfect Competition Model",
        "Unit 4: Imperfect Competition",
        "Unit 5: Factor Markets",
        "Unit 6: Market Failure and the Role of Government"
      ],
      "AP Music Theory": [
        "Unit 1: Music Fundamentals I",
        "Unit 2: Music Fundamentals II",
        "Unit 3: Music Fundamentals III",
        "Unit 4: Harmony and Voice Leading I",
        "Unit 5: Harmony and Voice Leading II",
        "Unit 6: Harmony and Voice Leading III",
        "Unit 7: Harmony and Voice Leading IV",
        "Unit 8: Modes and Form"
      ],
      "AP Physics 1": [
        "Unit 1: Kinematics",
        "Unit 2: Dynamics",
        "Unit 3: Circular Motion and Gravitation",
        "Unit 4: Energy",
        "Unit 5: Momentum",
        "Unit 6: Simple Harmonic Motion",
        "Unit 7: Torque and Rotational Motion"
      ],
      "AP Physics 2": [
        "Unit 1: Fluids",
        "Unit 2: Thermodynamics",
        "Unit 3: Electric Force, Field, and Potential",
        "Unit 4: Electric Circuits",
        "Unit 5: Magnetism and Electromagnetic Induction",
        "Unit 6: Geometric and Physical Optics",
        "Unit 7: Quantum, Atomic, and Nuclear Physics"
      ],
      "AP Physics C: Electricity & Magnetism": [
        "Unit 1: Electrostatics",
        "Unit 2: Conductors, Capacitors, Dielectrics",
        "Unit 3: Electric Circuits",
        "Unit 4: Magnetic Fields",
        "Unit 5: Electromagnetism"
      ],
      "AP Physics C: Mechanics": [
        "Unit 1: Kinematics",
        "Unit 2: Newton‚Äôs Laws of Motion",
        "Unit 3: Work, Energy, and Power",
        "Unit 4: Systems of Particles and Linear Momentum",
        "Unit 5: Rotation",
        "Unit 6: Oscillations",
        "Unit 7: Gravitation"
      ],
      "AP Pre-Calculus": [
        "Unit 1: Polynomial and Rational Functions",
        "Unit 2: Exponential and Logarithmic Functions",
        "Unit 3: Trigonometric and Polar Functions",
        "Unit 4: Functions Involving Parameters, Vectors, and Matrices"
      ],
      "AP Psychology": [
        "Unit 1: Scientific Foundations of Psychology",
        "Unit 2: Biological Basis of Behavior",
        "Unit 3: Sensation and Perception",
        "Unit 4: Learning",
        "Unit 5: Cognitive Psychology",
        "Unit 6: Developmental Psychology",
        "Unit 7: Motivation, Emotion, and Personality",
        "Unit 8: Clinical Psychology",
        "Unit 9: Social Psychology"
      ],
      "AP Research": [
        "Unit 1: Question and Explore",
        "Unit 2: Understand and Analyze",
        "Unit 3: Evaluate Multiple Perspectives",
        "Unit 4: Synthesize Ideas",
        "Unit 5: Team, Transform, and Transmit"
      ],
      "AP Seminar": [
        "Unit 1: Question and Explore",
        "Unit 2: Understand and Analyze",
        "Unit 3: Evaluate Multiple Perspectives",
        "Unit 4: Synthesize Ideas",
        "Unit 5: Team, Transform, and Transmit"
      ],
      "AP Spanish Language": [
        "Unit 1: Families in Different Societies",
        "Unit 2: The Influence of Language and Culture on Identity",
        "Unit 3: Influences of Beauty and Art",
        "Unit 4: How Science and Technology Affect Our Lives",
        "Unit 5: Factors That Impact the Quality of Life",
        "Unit 6: Environmental, Political, and Societal Challenges"
      ],
      "AP Spanish Literature": [
        "Unit 1: La √©poca medieval",
        "Unit 2: El siglo XVI",
        "Unit 3: El siglo XVII",
        "Unit 4: La literatura rom√°ntica, realista y naturalista",
        "Unit 5: La Generaci√≥n del 98 y el Modernismo",
        "Unit 6: Teatro y poes√≠a del siglo XX",
        "Unit 7: El Boom latinoamericano",
        "Unit 8: Escritores contempor√°neos de Estados Unidos, y Espa√±a"
      ],
      "AP Statistics": [
        "Unit 1: Exploring One-Variable Data",
        "Unit 2: Exploring Two-Variable Data",
        "Unit 3: Collecting Data",
        "Unit 4: Probability, Random Variables, and Probability Distributions",
        "Unit 5: Sampling Distributions",
        "Unit 6: Inference for Categorical Data - Proportions",
        "Unit 7: Inference for Quantitative Data - Means",
        "Unit 8: Inference for Categorical Data - Chi-Squares",
        "Unit 9: Inference for Quantitative Data - Slopes"
      ],
      "AP US Government": [
        "Unit 1: Foundations of American Democracy",
        "Unit 2: Interactions Among Branches of Government",
        "Unit 3: Civil Liberties and Civil Rights",
        "Unit 4: American Political Ideologies and Beliefs",
        "Unit 5: Political Participation"
      ],
      "AP US History": [
        "Unit 1: 1491-1607 (Columbus to Jamestown)",
        "Unit 2: 1607-1754 (Colonial Society)",
        "Unit 3: 1754-1800 (American Revolution and Constitution)",
        "Unit 4: 1800-1848 (American Expansion)",
        "Unit 5: 1844-1877 (Civil War and Reconstruction)",
        "Unit 6: 1865-1898 (Gilded Age)",
        "Unit 7: 1898-1945 (Global Conflict)",
        "Unit 8: 1945-1980 (Cold War and Protest)",
        "Unit 9: 1980 to Present (Post-Cold War Shifts)"
      ],
      "AP World History: Modern": [
        "Unit 1: The Global Tapestry",
        "Unit 2: Networks of Exchange",
        "Unit 3: Land-Based Empires",
        "Unit 4: Transoceanic Interactions",
        "Unit 5: Revolutions",
        "Unit 6: Consequences of Industrialization",
        "Unit 7: Global Conflict",
        "Unit 8: Cold War and Decolonization",
        "Unit 9: Globalization"
      ]
    };

    const GEMINI_API_KEY = "AIzaSyDNAAETxjKgPNYtH4kMu5rz0gvXad7UVwU";
const GEMINI_MODEL = "gemini-1.5-flash";
const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

async function withRetry(fn, maxRetries = 3, baseDelay = 2000) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      console.error(`Attempt ${attempt} failed:`, error.message);
      
      // Check for rate limiting (429) or server errors (5xx)
      const isRetryableError = error.message.includes('429') || 
                              error.message.includes('503') || 
                              error.message.includes('500') ||
                              error.message.includes('Failed to fetch');
      
      if (isRetryableError && attempt < maxRetries) {
        const delay = baseDelay * Math.pow(2, attempt - 1);
        console.log(`Retrying after ${delay}ms (attempt ${attempt}/${maxRetries})`);
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      throw error;
    }
  }
}

async function geminiJSON(prompt, schema) {
  const body = {
    contents: [{ 
      role: "user", 
      parts: [{ text: prompt }]
    }],
    generationConfig: {
      temperature: 0.7,
      topK: 40,
      topP: 0.95,
      maxOutputTokens: 4096,
      responseMimeType: "application/json",
      responseSchema: schema
    },
    safetySettings: [
      {
        category: "HARM_CATEGORY_HARASSMENT",
        threshold: "BLOCK_MEDIUM_AND_ABOVE"
      },
      {
        category: "HARM_CATEGORY_HATE_SPEECH",
        threshold: "BLOCK_MEDIUM_AND_ABOVE"
      }
    ]
  };

  return await withRetry(async () => {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
    
    try {
      const res = await fetch(GEMINI_URL, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "User-Agent": "Quiz-App/1.0"
        },
        body: JSON.stringify(body),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      if (!res.ok) {
        const errorText = await res.text();
        console.error(`Gemini API error: ${res.status} - ${res.statusText}`, errorText);
        
        // Handle specific error codes
        if (res.status === 429) {
          throw new Error(`Rate limit exceeded (429): ${errorText}`);
        } else if (res.status === 400) {
          throw new Error(`Bad request (400): ${errorText}`);
        } else if (res.status === 403) {
          throw new Error(`API key invalid or quota exceeded (403): ${errorText}`);
        } else if (res.status >= 500) {
          throw new Error(`Server error (${res.status}): ${errorText}`);
        }
        
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }

      const data = await res.json();
      
      // Better error handling for API response structure
      if (!data.candidates || data.candidates.length === 0) {
        console.error("No candidates in response:", data);
        throw new Error("No response candidates received from Gemini API");
      }

      const candidate = data.candidates[0];
      
      // Check for content filtering
      if (candidate.finishReason === "SAFETY" || candidate.finishReason === "BLOCKED_CONTENT") {
        throw new Error("Content was blocked by safety filters");
      }

      if (!candidate.content || !candidate.content.parts || candidate.content.parts.length === 0) {
        console.error("Invalid candidate structure:", candidate);
        throw new Error("Invalid response structure from Gemini API");
      }

      const text = candidate.content.parts[0].text;
      if (!text || text.trim() === '') {
        throw new Error("Empty response text received from Gemini API");
      }

      try {
        const parsed = JSON.parse(text.trim());
        return parsed;
      } catch (parseError) {
        console.error("JSON parse error:", parseError);
        console.error("Response text:", text);
        
        // Try to clean the response and parse again
        const cleanedText = text.replace(/```json\s?|\s?```/g, '').trim();
        try {
          return JSON.parse(cleanedText);
        } catch (secondParseError) {
          throw new Error(`Failed to parse Gemini response as JSON: ${parseError.message}`);
        }
      }
    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === 'AbortError') {
        throw new Error('Request timeout - Gemini API took too long to respond');
      }
      throw error;
    }
  });
}

async function generateQuiz(course, unit, isFinal = false) {
  if (!course || !unit) {
    throw new Error('Course and unit are required');
  }

  const count = isFinal ? 20 : 5;
  const mcqCount = isFinal ? 16 : 3;
  const sourceCount = isFinal ? 2 : 1;  // At least 2 for final
  const openCount = isFinal ? 4 : 1;

  const prompt = `You are an expert AP teacher creating ${isFinal ? 'a final exam' : 'a quiz'} for ${course}, focusing on: ${unit}.

Create exactly ${count} questions with this distribution:
- ${mcqCount} multiple choice questions (type: "mcq")
- ${sourceCount} source analysis questions (type: "source") 
- ${openCount} open response questions (type: "open")

Requirements:
1. All questions must be AP-level difficulty and curriculum-appropriate
2. Multiple choice questions: Include exactly 4 answer choices (A, B, C, D format), mark the correct answer, and provide a clear explanation
3. Source analysis questions: Include a primary/secondary source text, 4 analysis choices, correct answer, and explanation
4. Open response questions: Include detailed scoring rubric with specific criteria

Format each question as JSON with these exact fields:
- type: "mcq", "source", or "open"
- question: the question text
- source: (only for source-analysis questions) the source text to analyze
- choices: (for mcq/source only) array of exactly 4 answer choices
- correct: (for mcq/source only) the letter of the correct choice (A, B, C, or D)
- explanation: (for mcq/source only) why the answer is correct
- rubric: (for open only) detailed scoring criteria

Return only valid JSON in this format:
{
  "questions": [array of question objects]
}`;

  const schema = {
    type: "object",
    properties: {
      questions: {
        type: "array",
        minItems: count,
        maxItems: count,
        items: {
          type: "object",
          properties: {
            type: { 
              type: "string", 
              enum: ["mcq", "source", "open"] 
            },
            question: { 
              type: "string",
              minLength: 10
            },
            source: { 
              type: "string" 
            },
            choices: { 
              type: "array",
              items: { type: "string" },
              minItems: 4,
              maxItems: 4
            },
            correct: { 
              type: "string",
              enum: ["A", "B", "C", "D"]
            },
            explanation: { 
              type: "string",
              minLength: 10
            },
            rubric: { 
              type: "string",
              minLength: 20
            }
          },
          required: ["type", "question"]
        }
      }
    },
    required: ["questions"]
  };

  try {
    const maxAttempts = 3;
    let lastError;

    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      try {
        console.log(`Generating quiz for ${course} - ${unit} (attempt ${attempt})`);
        const response = await geminiJSON(prompt, schema);
        
        if (!response || !response.questions || !Array.isArray(response.questions)) {
          throw new Error("Invalid response structure - missing questions array");
        }

        const questions = response.questions;
        console.log(`Received ${questions.length} questions from Gemini`);

        // Validate and filter questions
        const validQuestions = questions.filter(q => {
          if (!q || typeof q !== 'object') {
            console.warn("Invalid question object:", q);
            return false;
          }

          if (!q.question || typeof q.question !== 'string' || q.question.trim().length === 0) {
            console.warn("Invalid or missing question text:", q);
            return false;
          }

          if (!q.type || !['mcq', 'source', 'open'].includes(q.type)) {
            console.warn("Invalid or missing question type:", q);
            return false;
          }

          // Validate MCQ and source questions
          if (q.type === 'mcq' || q.type === 'source') {
            if (!Array.isArray(q.choices) || q.choices.length !== 4) {
              console.warn("Invalid choices array:", q);
              return false;
            }
            
            if (!q.choices.every(c => typeof c === 'string' && c.trim().length > 0)) {
              console.warn("Invalid choice content:", q);
              return false;
            }

            if (!q.correct || !['A', 'B', 'C', 'D'].includes(q.correct)) {
              console.warn("Invalid correct answer:", q);
              return false;
            }

            if (!q.explanation || typeof q.explanation !== 'string' || q.explanation.trim().length === 0) {
              console.warn("Invalid explanation:", q);
              return false;
            }

            // Additional validation for source questions
            if (q.type === 'source' && (!q.source || typeof q.source !== 'string' || q.source.trim().length === 0)) {
              console.warn("Invalid source text:", q);
              return false;
            }
          }

          // Validate open response questions
          if (q.type === 'open') {
            if (!q.rubric || typeof q.rubric !== 'string' || q.rubric.trim().length === 0) {
              console.warn("Invalid rubric:", q);
              return false;
            }
          }

          return true;
        });

        console.log(`Validated ${validQuestions.length} questions out of ${questions.length}`);

        if (validQuestions.length === 0) {
          throw new Error("No valid questions generated");
        }

        // Check if we have minimum acceptable number of questions
        const minAcceptable = Math.ceil(count * 0.8); // Accept 80% of requested questions
        if (validQuestions.length < minAcceptable) {
          throw new Error(`Generated only ${validQuestions.length} valid questions, need at least ${minAcceptable}`);
        }

        // Ensure we have the right distribution (for final exams)
        if (isFinal) {
          const typeCounts = validQuestions.reduce((acc, q) => {
            acc[q.type] = (acc[q.type] || 0) + 1;
            return acc;
          }, {});

          if (typeCounts.open < 2) {
            console.warn(`Final exam should have at least 2 open response questions, got ${typeCounts.open}`);
          }
        }

        return validQuestions.slice(0, count); // Return exactly the requested number

      } catch (error) {
        console.error(`Quiz generation attempt ${attempt} failed:`, error.message);
        lastError = error;
        
        if (attempt < maxAttempts) {
          // Wait before retrying
          await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
        }
      }
    }

    throw new Error(`Failed to generate quiz after ${maxAttempts} attempts. Last error: ${lastError.message}`);

  } catch (error) {
    console.error("Quiz generation error:", error);
    throw new Error(`Failed to generate quiz for ${course} - ${unit}: ${error.message}`);
  }
}

async function gradeOpenResponse(course, unit, question, rubric, userAnswer) {
  if (!userAnswer || userAnswer.trim().length === 0) {
    return {
      pass: false,
      feedback: "No answer provided. Please write a response to receive credit."
    };
  }

  const prompt = `You are grading an AP-level open response question.

Course: ${course}
Unit: ${unit}
Question: ${question}
Scoring Rubric: ${rubric}

Student Answer:
"${userAnswer.trim()}"

Grade this response and provide constructive feedback. Be fair but maintain AP standards.

Determine:
1. Whether the response passes (meets minimum requirements for credit)
2. Specific, actionable feedback for improvement

Return JSON with:
- pass: boolean (true if response demonstrates adequate understanding)
- feedback: string (2-3 sentences of constructive feedback)`;

  const schema = {
    type: "object",
    properties: {
      pass: { type: "boolean" },
      feedback: { 
        type: "string",
        minLength: 20,
        maxLength: 500
      }
    },
    required: ["pass", "feedback"]
  };

  try {
    const response = await geminiJSON(prompt, schema);
    
    if (!response || typeof response.pass !== 'boolean' || !response.feedback) {
      throw new Error("Invalid grading response structure");
    }

    return {
      pass: response.pass,
      feedback: response.feedback.trim()
    };
    
  } catch (error) {
    console.error("Open response grading error:", error);
    
    // Fallback grading logic
    const wordCount = userAnswer.trim().split(/\s+/).length;
    const hasSubstance = wordCount >= 25; // Minimum word count for substance
    
    return {
      pass: hasSubstance,
      feedback: hasSubstance 
        ? "Your response has been recorded. Due to a technical issue, detailed feedback is not available, but your effort has been noted."
        : "Please provide a more substantial response (at least 25 words) that addresses the question thoroughly."
    };
  }
}

// Helper function to create DOM elements
function createEl(tag, className, text) {
  const el = document.createElement(tag);
  if (className) el.className = className;
  if (text) el.textContent = text;
  return el;
}

// Helper function to extract name from email
function nameFromEmail(email) {
  return (email || "Student").split("@")[0];
}

// Render AP courses for user (unchanged)
function renderAPCoursesForUser(selected, progressDoc = {}, xp = 0) {
  courseSelect.innerHTML = '<option value="" disabled>Select a Course</option>';
  unitsList.innerHTML = '';

  xpDisplay.textContent = `${xp}`;

  if (!selected || selected.length === 0) {
    unitsList.textContent = "No courses selected. Open settings to select courses.";
    unitsList.className = "text-white";
    return;
  }

  selected.forEach(courseName => {
    const option = createEl('option', '', courseName);
    option.value = courseName;
    courseSelect.appendChild(option);
  });

  if (selected.length > 0) {
    courseSelect.value = selected[0];
    renderUnits(selected[0], progressDoc);
  }

  courseSelect.addEventListener('change', () => {
    const selectedCourse = courseSelect.value;
    renderUnits(selectedCourse, progressDoc);
  });
}

// Render units (unchanged)
function renderUnits(courseName, progressDoc = {}) {
  unitsList.innerHTML = '';
  const units = apCourses[courseName];
  if (!units) {
    unitsList.textContent = 'No units available for this course.';
    unitsList.className = "text-white";
    return;
  }

  units.forEach(unit => {
    const unitBtn = createEl('button', '', unit);
    const check = createEl('span', 'ml-2 text-green-400');
    if (progressDoc?.[courseName]?.[unit]?.passed) check.textContent = '‚úÖ';
    unitBtn.appendChild(check);
    unitBtn.addEventListener('click', () => openUnitQuiz(courseName, unit, check));
    unitsList.appendChild(unitBtn);
  });

  const finalBtn = createEl('button', 'text-white', 'Final Exam');
  const finalCheck = createEl('span', 'ml-2 text-green-400');
  if (progressDoc?.finalExams?.[courseName]?.passed) finalCheck.textContent = '‚úÖ';
  finalBtn.appendChild(finalCheck);
  finalBtn.addEventListener('click', () => openFinalExam(courseName, finalCheck));
  unitsList.appendChild(finalBtn);
}

async function openUnitQuiz(course, unit, checkSpan) {
  const modal = createEl('div', 'fixed inset-0 bg-black/50 flex items-center justify-center z-50');
  modal.id = 'quizModal';
  modal.classList.add('show');
  modal.innerHTML = `
    <div class="bg-gray-800 p-6 rounded-2xl max-w-2xl w-full shadow-xl">
      <h2 class="font-bold text-xl text-white mb-4">${course} ‚Äî ${unit}</h2>
      <div id="quizContent">
        <div class="text-center">
          <button id="startQuiz" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-500 transition-colors">
            Start Quiz
          </button>
          <p class="text-gray-300 mt-2">5 questions ‚Ä¢ Pass with 4/5 correct</p>
        </div>
      </div>
      <button id="closeQuiz" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors">Close</button>
    </div>`;
  
  document.body.appendChild(modal);
  const quizContent = modal.querySelector('#quizContent');
  modal.querySelector('#closeQuiz').onclick = () => modal.remove();

  modal.querySelector('#startQuiz').onclick = async () => {
    quizContent.innerHTML = '<div class="text-center text-white"><p>Generating quiz...</p><div class="spinner"></div></div>';
    
    try {
      const questions = await generateQuiz(course, unit, false);
      showQuizModal(course, unit, questions, 5, 4, checkSpan, false, modal, quizContent);
    } catch (error) {
      console.error('Failed to load quiz:', error);
      quizContent.innerHTML = `
        <div class="text-center text-white">
          <p class="text-red-400 mb-4">‚ùå Error loading quiz</p>
          <p class="text-sm text-gray-300 mb-4">${error.message}</p>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-500">
            Try Again Later
          </button>
        </div>`;
    }
  };
}

async function openFinalExam(course, checkSpan) {
  const modal = createEl('div', 'fixed inset-0 bg-black/50 flex items-center justify-center z-50');
  modal.id = 'quizModal';
  modal.classList.add('show');
  modal.innerHTML = `
    <div class="bg-gray-800 p-6 rounded-2xl max-w-2xl w-full shadow-xl">
      <h2 class="font-bold text-xl text-white mb-4">${course} ‚Äî Final Exam</h2>
      <div id="quizContent">
        <div class="text-center">
          <button id="startQuiz" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-500 transition-colors">
            Start Final Exam
          </button>
          <p class="text-gray-300 mt-2">20 questions ‚Ä¢ Pass with 16/20 correct</p>
          <p class="text-yellow-300 text-sm mt-1">‚ö†Ô∏è This may take longer to generate</p>
        </div>
      </div>
      <button id="closeQuiz" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors">Close</button>
    </div>`;
  
  document.body.appendChild(modal);
  const quizContent = modal.querySelector('#quizContent');
  modal.querySelector('#closeQuiz').onclick = () => modal.remove();

  modal.querySelector('#startQuiz').onclick = async () => {
    quizContent.innerHTML = '<div class="text-center text-white"><p>Generating final exam...</p><p class="text-sm text-gray-400">This may take up to 30 seconds</p><div class="spinner"></div></div>';
    
    try {
      const questions = await generateQuiz(course, 'Final Exam', true);
      showQuizModal(course, 'Final Exam', questions, 10, 8, checkSpan, true, modal, quizContent);
    } catch (error) {
      console.error('Failed to load final exam:', error);
      quizContent.innerHTML = `
        <div class="text-center text-white">
          <p class="text-red-400 mb-4">‚ùå Error loading final exam</p>
          <p class="text-sm text-gray-300 mb-4">${error.message}</p>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-500">
            Try Again Later
          </button>
        </div>`;
    }
  };
}

async function showQuizModal(course, unit, questions, totalCount, passThreshold, checkSpan, isFinal, modal, quizContent) {
  let currentIndex = 0;
  let score = 0;
  let earnedXP = 0;

  async function renderCurrentQuestion() {
    if (currentIndex >= questions.length) {
      // Quiz completed - show results
      const passed = score >= passThreshold;
      const percentage = Math.round((score / totalCount) * 100);
      
      quizContent.innerHTML = `
        <div class="text-center">
          <div class="mb-6">
            <h3 class="text-2xl font-bold ${passed ? 'text-green-400' : 'text-red-400'} mb-2">
              ${passed ? '‚úÖ Passed!' : '‚ùå Not Passed'}
            </h3>
            <p class="text-white text-lg">Score: ${score}/${totalCount} (${percentage}%)</p>
            <p class="text-purple-300">Earned XP: +${earnedXP}</p>
          </div>
          
          ${!passed ? `
            <p class="text-gray-300 mb-4">
              You need ${passThreshold}/${totalCount} to pass. Try again to improve your score!
            </p>
          ` : ''}
          
          <button onclick="this.closest('.fixed').remove()" 
                  class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-500">
            Continue
          </button>
        </div>`;

      // Save progress to Firebase
      try {
        const user = auth.currentUser;
        if (user) {
          const userRef = doc(db, 'users', user.uid);
          
          if (passed) {
            const progressUpdate = isFinal 
              ? { finalExams: { [course]: { passed: true, score } } }
              : { progress: { [course]: { [unit]: { passed: true, score } } } };
            
            await setDoc(userRef, progressUpdate, { merge: true });
            checkSpan.textContent = '‚úÖ';
          }
          
          // Update XP
          const userSnap = await getDoc(userRef);
          const currentXP = userSnap.data()?.xp || 0;
          await updateDoc(userRef, { xp: currentXP + earnedXP });
          xpDisplay.textContent = `${currentXP + earnedXP}`;
        }
      } catch (error) {
        console.error('Failed to save progress:', error);
      }
      
      return;
    }

    const question = questions[currentIndex];
    const questionNumber = currentIndex + 1;

    quizContent.innerHTML = `
      <div class="mb-4">
        <div class="flex justify-between items-center mb-4">
          <span class="text-purple-300 font-semibold">Question ${questionNumber} of ${questions.length}</span>
          <span class="text-gray-400">Score: ${score}/${currentIndex}</span>
        </div>
        
        <div class="bg-gray-700 p-4 rounded-lg">
          <h3 class="font-semibold text-white mb-3">${question.question}</h3>
          
          ${question.source ? `
            <div class="bg-gray-600 p-3 rounded mb-4">
              <p class="text-sm text-gray-300 italic">${question.source}</p>
            </div>
          ` : ''}
          
          <div id="questionContent"></div>
        </div>
      </div>`;

    const questionContent = quizContent.querySelector('#questionContent');

    if (question.type === 'mcq' || question.type === 'source') {
      // Multiple choice question
      const choices = ['A', 'B', 'C', 'D'];
      question.choices.forEach((choice, index) => {
        const button = createEl('button', 
          'w-full text-left p-3 mb-2 bg-gray-600 hover:bg-gray-500 rounded transition-colors text-white',
          `${choices[index]}. ${choice}`
        );
        
        button.onclick = () => {
          const isCorrect = choices[index] === question.correct;
          if (isCorrect) {
            score++;
            earnedXP += 15;
            button.className = 'w-full text-left p-3 mb-2 bg-green-600 rounded text-white';
          } else {
            button.className = 'w-full text-left p-3 mb-2 bg-red-600 rounded text-white';
          }
          
          // Disable all buttons and show explanation
          questionContent.querySelectorAll('button').forEach(btn => btn.disabled = true);
          
          setTimeout(() => {
            currentIndex++;
            renderCurrentQuestion();
          }, 2000);
        };
        
        questionContent.appendChild(button);
      });
      
    } else if (question.type === 'open') {
      // Open response question
      const textarea = document.createElement('textarea');
      textarea.className = 'w-full h-32 p-3 bg-gray-600 text-white rounded border border-gray-500 resize-none';
      textarea.placeholder = 'Type your answer here...';
      
      const submitButton = createEl('button', 
        'mt-3 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed',
        'Submit Answer'
      );
      submitButton.disabled = true;
      
      textarea.oninput = () => {
        submitButton.disabled = textarea.value.trim().length < 10;
      };
      
      submitButton.onclick = async () => {
        submitButton.disabled = true;
        submitButton.textContent = 'Grading...';
        
        try {
          const result = await gradeOpenResponse(course, unit, question.question, question.rubric, textarea.value);
          
          if (result.pass) {
            score++;
            earnedXP += 50;
          }
          
          // Show feedback
          const feedbackDiv = createEl('div', 
            `mt-4 p-3 rounded ${result.pass ? 'bg-green-800 border border-green-600' : 'bg-red-800 border border-red-600'}`,
            result.feedback
          );
          feedbackDiv.style.color = 'white';
          questionContent.appendChild(feedbackDiv);
          
          setTimeout(() => {
            currentIndex++;
            renderCurrentQuestion();
          }, 3000);
          
        } catch (error) {
          console.error('Failed to grade open response:', error);
          submitButton.textContent = 'Grading Failed';
          setTimeout(() => {
            currentIndex++;
            renderCurrentQuestion();
          }, 2000);
        }
      };
      
      questionContent.appendChild(textarea);
      questionContent.appendChild(submitButton);
    }
  }

  // Start the quiz
  renderCurrentQuestion();
}
    function openSettings() {
      settingsModal.classList.remove('hidden');
      settingsModal.classList.add('show');
    }

    function closeSettingsModal() {
      settingsModal.classList.add('hidden');
      settingsModal.classList.remove('show');
    }

    function openReselect() {
      reselectModal.classList.remove('hidden');
      reselectModal.classList.add('show');
    }

    function closeReselectModal() {
      reselectModal.classList.add('hidden');
      reselectModal.classList.remove('show');
    }

    function populateReselectForm(selected = []) {
      reselectForm.innerHTML = '';
      Object.keys(apCourses).forEach(course => {
        const label = createEl('label', 'block mb-1 text-white');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = course;
        if (selected.includes(course)) input.checked = true;
        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${course}`));
        reselectForm.appendChild(label);
      });
    }

    let redirectTimeout = setTimeout(() => {
      if (!auth.currentUser) {
        window.location.href = 'index.html';
      }
    }, 5000);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log('No user signed in yet, waiting...');
        return;
      }

      clearTimeout(redirectTimeout);

      const ref = doc(db, 'users', user.uid);
      let snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { apCourses: [], progress: {}, finalExams: {}, xp: 0 });
        snap = await getDoc(ref);
      }
      const data = snap.data();

      courses.textContent = `Courses`;

      renderAPCoursesForUser(data.apCourses || [], data.progress || {}, data.xp || 0);

      settingsBtn.onclick = openSettings;
      closeSettings.onclick = closeSettingsModal;
      reselectBtn.onclick = openReselect;
      closeReselect.onclick = closeReselectModal;
      populateReselectForm(data.apCourses || []);
      saveReselect.onclick = async () => {
        const selected = Array.from(reselectForm.querySelectorAll('input:checked')).map(cb => cb.value);
        await setDoc(ref, { apCourses: selected }, { merge: true });
        renderAPCoursesForUser(selected, data.progress || {}, data.xp || 0);
        reselectModal.classList.add('hidden');
        reselectModal.classList.remove('show');
      };
      logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = 'index.html';
      };
    });
  </script>
</body>
</html>
